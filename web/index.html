<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>权重随机抽人</title>
<style>
 .pointer{
  width:0;
  height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-bottom:22px solid #ef4444;
  position:absolute;
  top:8px;
  left:50%;
  transform:translateX(-50%);
  z-index:10;
}
  :root{
    --accent:#2563eb;
    --muted:#6b7280;
    --bg:#ffffff;
    --card:#f8fafc;
    --radius:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, "Helvetica Neue", Arial, sans-serif;color:#111827;}
  .container{max-width:1100px;margin:28px auto;padding:20px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;align-items:center;}
  /* From Uiverse.io by ShadowShahriar */ 
button {
 --border-radius: 13px;
 --border-width: 4px;
 appearance: none;
 position: relative;
 padding: 1em 2em;
 border: 0;
 background-color: #212121;
 font-family: "Roboto", Arial, "Segoe UI", sans-serif;
 font-size: 14px;
 font-weight: 500;
 color: #fff;
 z-index: 2;
}

button::after {
 --m-i: linear-gradient(#000, #000);
 --m-o: content-box, padding-box;
 content: "";
 position: absolute;
 left: 0;
 top: 0;
 width: 100%;
 height: 100%;
 padding: var(--border-width);
 border-radius: var(--border-radius);
 background-image: conic-gradient(
		#488cfb,
		#29dbbc,
		#ddf505,
		#ff9f0e,
		#e440bb,
		#655adc,
		#488cfb
	);
 -webkit-mask-image: var(--m-i), var(--m-i);
 mask-image: var(--m-i), var(--m-i);
 -webkit-mask-origin: var(--m-o);
 mask-origin: var(--m-o);
 -webkit-mask-clip: var(--m-o);
 mask-composite: exclude;
 -webkit-mask-composite: destination-out;
 filter: hue-rotate(0);
 animation: rotate-hue linear 500ms infinite;
 animation-play-state: paused;
}
/* From Uiverse.io by AqFox */ 
.spinner {
  width: 44px;
  height: 44px;
  animation: spinner-y0fdc1 2s infinite ease;
  transform-style: preserve-3d;
}

.spinner > div {
  background-color: rgba(0,77,255,0.2);
  height: 100%;
  position: absolute;
  width: 100%;
  border: 2px solid #004dff;
}

.spinner div:nth-of-type(1) {
  transform: translateZ(-22px) rotateY(180deg);
}

.spinner div:nth-of-type(2) {
  transform: rotateY(-270deg) translateX(50%);
  transform-origin: top right;
}

.spinner div:nth-of-type(3) {
  transform: rotateY(270deg) translateX(-50%);
  transform-origin: center left;
}

.spinner div:nth-of-type(4) {
  transform: rotateX(90deg) translateY(-50%);
  transform-origin: top center;
}

.spinner div:nth-of-type(5) {
  transform: rotateX(-90deg) translateY(50%);
  transform-origin: bottom center;
}

.spinner div:nth-of-type(6) {
  transform: translateZ(22px);
}

@keyframes spinner-y0fdc1 {
  0% {
    transform: rotate(45deg) rotateX(-25deg) rotateY(25deg);
  }

  50% {
    transform: rotate(45deg) rotateX(-385deg) rotateY(25deg);
  }

  100% {
    transform: rotate(45deg) rotateX(-385deg) rotateY(385deg);
  }
}

/* 加载遮罩 */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}
button:hover::after {
 animation-play-state: running;
}

@keyframes rotate-hue {
 to {
  filter: hue-rotate(1turn);
 }
}

button,
button::after {
 box-sizing: border-box;
}
/* From Uiverse.io by anniekoop */ 
.input {
  padding: 0.875rem;
  font-size: 1rem;
  border: 1.5px solid #000;
  border-radius: 0.5rem;
  box-shadow: 2.5px 3px 0 #000;
  outline: none;
  transition: ease 0.25s;
  flex: 1;
}

.input:focus {
  box-shadow: 5.5px 7px 0 black;
}
button:active {
 --border-width: 5px;
}
/* 移动端优化 */
@media (max-width: 768px) {
  .container {
    padding: 12px;
    margin: 12px auto;
  }
  
  .layout {
    gap: 12px;
  }
  
  .card {
    padding: 12px;
  }
  
  .wheel {
    width: 200px;
    height: 200px;
  }
  
  .wheel-label-display, .turntable-label {
    font-size: 18px;
    min-width: 100px;
  }
  
  .display-name {
    font-size: 22px;
  }
  
  .controls {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }
  
  .config {
    flex-direction: column;
    align-items: stretch;
  }
  
  .config > * {
    width: 100%;
  }
  
  input[type="number"], input[type="text"], select {
    font-size: 16px; /* 防止iOS缩放 */
  }
  
  .add-row {
    flex-direction: column;
    align-items: stretch;
  }
  
  .add-row input {
    width: 100%;
  }
  
  .actions {
    flex-direction: column;
    gap: 4px;
  }
}
  button.ghost{--border-radius: 13px;--border-width: 4px;appearance:none;position:relative;padding:0.7em 1.5em;border:0;background-color:#f8fafc;font-family:"Roboto",Arial,"Segoe UI",sans-serif;font-size:14px;font-weight:500;color:#212121;z-index:2;}
  button.ghost::after{--m-i:linear-gradient(#000,#000);--m-o:content-box,padding-box;content:"";position:absolute;left:0;top:0;width:100%;height:100%;padding:var(--border-width);border-radius:var(--border-radius);background-image:conic-gradient(#488cfb,#29dbbc,#ddf505,#ff9f0e,#e440bb,#655adc,#488cfb);-webkit-mask-image:var(--m-i),var(--m-i);mask-image:var(--m-i),var(--m-i);-webkit-mask-origin:var(--m-o);mask-origin:var(--m-o);-webkit-mask-clip:var(--m-o);mask-composite:exclude;-webkit-mask-composite:destination-out;filter:hue-rotate(0);animation:rotate-hue linear 500ms infinite;animation-play-state:paused;}
  button.ghost:hover::after{animation-play-state:running;}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(12,20,30,0.04);}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:18px;}
  /* left panel */
  .left{display:flex;flex-direction:column;gap:12px}
  .list-header{display:flex;justify-content:space-between;align-items:center}
  .fold-toggle{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px}
  .name-list{max-height:340px;overflow:auto;padding:8px;border-radius:10px;background:#fff;border:1px solid #eef2ff}
  .list-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;margin-bottom:6px}
  .list-row:hover{background:#f1f5f9}
  .name{font-weight:600}
  .weight{font-size:13px;color:var(--muted);margin-left:12px}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:6px}
  .icon-btn{--border-radius:8px;--border-width:2px;appearance:none;position:relative;padding:6px 12px;border:0;background-color:#f8fafc;font-family:"Roboto",Arial,"Segoe UI",sans-serif;font-size:13px;font-weight:500;color:#212121;z-index:2;min-width:40px;text-align:center;}
  .icon-btn::after{--m-i:linear-gradient(#000,#000);--m-o:content-box,padding-box;content:"";position:absolute;left:0;top:0;width:100%;height:100%;padding:var(--border-width);border-radius:var(--border-radius);background-image:conic-gradient(#488cfb,#29dbbc,#ddf505,#ff9f0e,#e440bb,#655adc,#488cfb);-webkit-mask-image:var(--m-i),var(--m-i);mask-image:var(--m-i),var(--m-i);-webkit-mask-origin:var(--m-o);mask-origin:var(--m-o);-webkit-mask-clip:var(--m-o);mask-composite:exclude;-webkit-mask-composite:destination-out;filter:hue-rotate(0);animation:rotate-hue linear 500ms infinite;animation-play-state:paused;}
  .icon-btn:hover::after{animation-play-state:running;}
  input[type="number"], input[type="text"]{padding:6px;border-radius:8px;border:1px solid #e6e6e6}
  .add-row{display:flex;gap:8px;align-items:center;margin-top:6px}
  .advanced-panel{margin-top:8px;padding:12px;border-radius:10px;background:#fff;border:1px solid #eef2ff}
  label{font-size:13px;color:var(--muted)}
  /* right panel */
  .right{display:flex;flex-direction:column;gap:12px}
  .config{display:flex;gap:12px;align-items:center}
  .config > *{flex:1}
  .big-display{height:220px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#f8fbff);display:flex;align-items:center;justify-content:center;flex-direction:column;border:1px dashed #e6eefc}
  .display-name{font-size:28px;font-weight:700}
  .sub{color:var(--muted);font-size:13px}
  .results{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:white;padding:8px 12px;border-radius:999px;border:1px solid #eef2ff;font-weight:600}
  footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:999;}
  .modal{background:white;padding:18px;border-radius:12px;min-width:320px;max-width:90%}
  .modal h3{margin:0 0 8px 0}
  .modal .result-list{display:flex;gap:8px;flex-wrap:wrap}
  /* animation modal */
  .animation-modal{background:white;padding:24px;border-radius:16px;min-width:500px;max-width:90%;text-align:center;position:relative;}
  .animation-modal h3{margin-top:0;margin-bottom:20px;}
  .animation-content{display:flex;flex-direction:column;align-items:center;gap:20px;}
  .animation-display{font-size:32px;font-weight:700;color:#2563eb;min-height:60px;display:flex;align-items:center;justify-content:center;}
  /* collapsed default json */
  .json-area{font-family:monospace;background:#0f172a;color:#f8fafc;padding:10px;border-radius:8px;max-height:160px;overflow:auto}
  /* small screens */
  @media (max-width:880px){
    .layout{grid-template-columns:1fr; }
    .left{order:2}
    .animation-modal{min-width:90%;padding:16px;}
  }

  .primary-large{--border-radius:12px;--border-width:4px;appearance:none;position:relative;padding:12px 28px;border:0;background-color:#2563eb;font-family:"Roboto",Arial,"Segoe UI",sans-serif;font-size:16px;font-weight:700;color:#fff;z-index:2;cursor:pointer;box-shadow:0 6px 18px rgba(37,99,235,0.12);}
  .primary-large::after{--m-i:linear-gradient(#000,#000);--m-o:content-box,padding-box;content:"";position:absolute;left:0;top:0;width:100%;height:100%;padding:var(--border-width);border-radius:var(--border-radius);background-image:conic-gradient(#488cfb,#29dbbc,#ddf505,#ff9f0e,#e440bb,#655adc,#488cfb);-webkit-mask-image:var(--m-i),var(--m-i);mask-image:var(--m-i),var(--m-i);-webkit-mask-origin:var(--m-o);mask-origin:var(--m-o);-webkit-mask-clip:var(--m-o);mask-composite:exclude;-webkit-mask-composite:destination-out;filter:hue-rotate(0);animation:rotate-hue linear 500ms infinite;animation-play-state:paused;}
  .primary-large:hover::after{animation-play-state:running;}
  /* wheel / roulette styles */
  .wheel-wrap{display:flex;justify-content:center;align-items:center;gap:20px;flex-direction:row;position:relative}
  .wheel{width:280px;height:280px;border-radius:50%;position:relative;overflow:hidden;border:6px solid #fff;box-shadow:0 8px 22px rgba(2,6,23,0.06)}
  .wheel .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;font-weight:700}
  .wheel-label-display{font-size:24px;font-weight:700;color:#111827;min-width:120px;text-align:center;padding:12px;border-radius:12px;background:#f8fafc;border:2px solid #eef2ff;}
  /* 优化指针样式 */
.wheel-pointer {
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
  display: flex;
  flex-direction: column;
  align-items: center;
}

.wheel-pointer::before,
.wheel-pointer::after {
  content: '';
  width: 0;
  height: 0;
}

.wheel-pointer::before {
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-bottom: 20px solid #ef4444;
  margin-bottom: 2px; /* 两个三角形之间的间距 */
}

.wheel-pointer::after {
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 20px solid #ef4444;
}

/* 在指针中间添加显示区域 */
.wheel-pointer-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  color: #ef4444;
  border: 1px solid #ef4444;
  white-space: nowrap;
  z-index: 11;
}
  /* small adjustments for wheel text */
  @media (max-width:880px){ .wheel{width:220px;height:220px} }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>权重随机抽人器By-MorningStarsX</h1>
      <div class="small">初始权重 1.0 · 抽中后权重 × <span id="multiplierLabel">0.4</span></div>
    </div>
    <div class="controls">
      <button id="advancedBtn" class="ghost">高级设置</button>
    </div>
  </header>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div class="list-header">
          <strong>名单(折叠)</strong>
          <button class="fold-toggle" id="toggleDefault">展开默认名单</button>
        </div>

        <div id="defaultCollapsed" style="display:none;margin-top:10px;">
          <div class="json-area" id="defaultJson"></div>
        </div>

        <div style="height:8px"></div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="search" placeholder="搜索名字" class="input">
          <button id="addSample" class="icon-btn" title="添加示例">＋</button>
          <button id="resetDefault" class="icon-btn" title="恢复默认">↺</button>
        </div>

        <div class="name-list" id="nameList"></div>

        <div class="add-row">
          <input id="newName" placeholder="新名字" />
          <input id="newWeight" type="number" step="0.1" value="1.0" style="width:86px" />
          <button id="addBtn" class="icon-btn">添加</button>
        </div>
      </div>

      <div class="advanced-panel card" id="advancedPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>高级设置</strong>
          <button id="closeAdvanced" class="ghost">关闭</button>
        </div>

        <div style="margin-top:10px;display:grid;gap:8px">
          <label>权重更新量(抽中后乘以)</label>
          <input id="multiplier" type="number" step="0.01" min="0" max="1" value="0.4" />

          <label>抽取动画</label>
          <select id="animationSelect">
            <option value="roulette">轮盘式 (Roulette)</option>
          </select>

          <label>导入名单(JSON 格式：{"名字":1.0, ...})</label>
          <textarea id="importJson" placeholder='{"张三":1.0, "李四":1.0}' rows="4" style="padding:8px;border-radius:8px;border:1px solid #e6eefc"></textarea>
          <div style="display:flex;gap:8px">
            <button id="importBtn" class="ghost">导入名单</button>
            <button id="exportBtn" class="ghost">导出名单</button>
            <button id="downloadBtn" class="ghost">下载 JSON 文件</button>
            <input type="file" id="fileInput" accept=".json" style="display:none" />
          </div>

          <label>默认名单(只读，折叠)</label>
          <div class="json-area" id="defaultJson2" style="max-height:100px"></div>
        </div>
      </div>

    </div>

    <div class="right">
      <div class="card config">
        <div>
          <label>抽取数量(1 = 单人)</label>
          <input id="count" type="number" value="1" min="1" style="width:120px" />
        </div>
        <div>
          <label>是否按顺序更新权重</label>
          <select id="updateMode" style="width:160px">
            <option value="sequential">顺序更新(每次抽后立即更新，影响下一次抽)</option>
            <option value="independent">独立抽取(基于初始权重，同次抽取互不影响)</option>
          </select>
        </div>
      </div>

      <div class="big-display card">
        <div id="animArea" style="text-align:center;width:100%;padding:10px">
          <div class="display-name" id="animName">准备就绪</div>
          <div class="sub">点击"开始抽取"按钮进行抽选</div>
        </div>
      </div>

      <div style="text-align:center;margin-top:12px">
        <button id="drawBtn" class="primary-large">开始抽取</button>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>最近抽取结果</strong>
          <button id="clearHistory" class="ghost">清除</button>
        </div>
        <div style="margin-top:8px" id="historyList"></div>
      </div>

      <footer>
        <div>当前总人数：<span id="totalCount">0</span></div>
        <div class="small">数据保存在本地</div>
      </footer>
    </div>
  </div>
</div>

<!-- result modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3>抽取结果</h3>
    <div class="result-list" id="modalResults"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="closeModal" class="ghost">关闭</button>
    </div>
  </div>
</div>

<!-- animation modal -->
<div class="modal-backdrop" id="animationModal" style="display:none;">
  <div class="animation-modal">
    <h3 id="animationTitle">抽取动画</h3>
    <div class="animation-content" id="animationContent">
      <div class="animation-display" id="animationDisplay">准备中...</div>
    </div>
    <div style="margin-top:20px;">
      <button id="cancelAnimation" class="ghost">取消</button>
    </div>
  </div>
</div>

<script>
/* ======== 默认名单(2027届17班) ======== */
const DEFAULT_LIST = {
"曾佳怡":1.0, "陈凯":1.0, "陈俐肜":1.0, "陈芋雄":1.0, "陈哲宇":1.0, "陈子萓":1.0, "邓蓉清":1.0, "杜韦鹏":1.0, "方毅":1.0, "符丰牧":1.0,
"符智晨":1.0, "黄艳萍":1.0, "黄志威":1.0, "揭弘毅":1.0, "揭子尧":1.0, "赖聪":1.0, "赖婷":1.0, "赖亚宁":1.0, "赖雨欣":1.0, "赖钰玲":1.0,
"李诚铚":1.0, "李华珍":1.0, "李惠东":1.0, "李哲聪":1.0, "廖鸿瑞":1.0, "廖俊":1.0, "刘扬":1.0, "刘艺":1.0, "马哲灏":1.0, "聂娅馨":1.0,
"瞿世浓":1.0, "饶俊彦":1.0, "饶淑玲":1.0, "饶文垒":1.0, "饶咏坤":1.0, "魏如俊":1.0, "魏志雄":1.0, "魏智萱":1.0, "温粤凡":1.0, "吴博宇":1.0,
"吴海艳":1.0, "吴和兴":1.0, "夏浩轩":1.0, "夏禹豪":1.0, "肖志远":1.0, "谢佳童":1.0, "谢近哲":1.0, "谢雨欣":1.0, "幸天睿":1.0, "熊宇勋":1.0,
"徐子豪":1.0, "杨嘉琦":1.0, "叶丹":1.0, "余凡":1.0, "余梦瑶":1.0
};

/* ======== State & helpers ======== */
let state = {
  list: {}, // {name: weight}
  multiplier: 0.4,
  animation: 'roulette',
  history: []
};

const el = id => document.getElementById(id);

function loadState(){
  try{
    // 清空本地存储数据
    localStorage.removeItem('weighted_draw_state_v1');
    // 使用默认名单
    state.list = {...DEFAULT_LIST};
    // 重置其他状态
    state.history = [];
    state.multiplier = 0.4;
    state.animation = 'roulette';
    // 保存默认状态到本地存储
    saveState();
  }catch(e){
    console.warn('加载状态出错:', e);
    // 确保即使出错也有默认值
    state.list = {...DEFAULT_LIST};
    state.history = [];
    state.multiplier = 0.4;
    state.animation = 'roulette';
    saveState();
  }
}

function saveState(){
  localStorage.setItem('weighted_draw_state_v1', JSON.stringify(state));
}

/* ======== UI 渲染 ======== */
function renderList(filter=''){
  const container = el('nameList');
  container.innerHTML = '';
  const entries = Object.entries(state.list).sort((a,b)=> b[1]-a[1]);
  entries.filter(([n])=> n.toLowerCase().includes(filter.toLowerCase())).forEach(([name, w])=>{
    const row = document.createElement('div');
    row.className = 'list-row';
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="name">${name}</div>
        <div class="weight">权重 ${Number(w).toFixed(3)}</div>
      </div>
      <div class="actions">
        <input type="number" step="0.1" value="${w}" style="width:88px;padding:6px;border-radius:8px;border:1px solid #e6eefc" data-name="${name}" class="editWeight"/>
        <button class="icon-btn" data-name="${name}" data-action="del">删除</button>
      </div>
    `;
    container.appendChild(row);
  });
  el('totalCount').innerText = entries.length;
  // attach edit handlers
  document.querySelectorAll('.editWeight').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const n = e.target.dataset.name;
      let v = parseFloat(e.target.value);
      if(isNaN(v) || v < 0) v = 0;
      state.list[n] = v;
      saveState();
      renderList(el('search').value.trim());
    });
  });
  document.querySelectorAll('button[data-action="del"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const name = e.currentTarget.dataset.name;
      if(confirm('删除 ' + name + ' ?')){
        delete state.list[name];
        saveState();
        renderList(el('search').value.trim());
      }
    });
  });
}

function renderHistory(){
  const box = el('historyList');
  box.innerHTML = '';
  for(let i=state.history.length-1;i>=0;i--){
    const rec = state.history[i];
    const d = new Date(rec.time).toLocaleString();
    const div = document.createElement('div');
    div.className = 'small';
    div.style.marginBottom='6px';
    div.innerHTML = `<strong>${d}</strong> — ${rec.results.map(r=>`<span class="chip">${r}</span>`).join(' ')}`;
    box.appendChild(div);
  }
}

/* ======== Weighted random pick helpers ======== */
function weightedPickOnce(listObj){
  const names = Object.keys(listObj);
  const weights = names.map(n=> Number(listObj[n]) );
  const total = weights.reduce((a,b)=>a+b,0);
  if(total <= 0) return null;
  const rnd = Math.random() * total;
  let s = 0;
  for(let i=0;i<names.length;i++){
    s += weights[i];
    if(rnd <= s) return names[i];
  }
  return names[names.length-1];
}

function pickMultiple(count, mode='sequential'){
  const tempList = {...state.list};
  const results = [];
  if(mode === 'independent'){
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(tempList);
      if(!pick) break;
      results.push(pick);
    }
    results.forEach(name=>{
      if(name in state.list){
        state.list[name] = Number(state.list[name]) * Number(state.multiplier);
      }
    });
    return results;
  }else{
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(tempList);
      if(!pick) break;
      results.push(pick);
      tempList[pick] = Number(tempList[pick]) * Number(state.multiplier);
      if(pick in state.list) state.list[pick] = Number(state.list[pick]) * Number(state.multiplier);
    }
    return results;
  }
}

/* ======== Animation implementations ======== */
function pickSimulated(count, mode){
  const original = {...state.list};
  const names = Object.keys(original);
  if(names.length === 0) return [];
  function weightedOnce(listObj){
    const nms = Object.keys(listObj);
    const w = nms.map(k=> Number(listObj[k]));
    const total = w.reduce((a,b)=>a+b,0);
    if(total <= 0) return null;
    let rnd = Math.random()*total;
    let s=0;
    for(let i=0;i<nms.length;i++){
      s+=w[i];
      if(rnd<=s) return nms[i];
    }
    return nms[nms.length-1];
  }
  const results = [];
  if(mode === 'independent'){
    for(let i=0;i<count;i++){
      const pick = weightedOnce(original);
      if(!pick) break;
      results.push(pick);
    }
    return results;
  }else{
    const temp = {...original};
    for(let i=0;i<count;i++){
      const pick = weightedOnce(temp);
      if(!pick) break;
      results.push(pick);
      temp[pick] = Number(temp[pick]) * Number(state.multiplier);
    }
    return results;
  }
}

function applyPickedResults(results){
  if(!results || results.length===0) return;
  if(el('updateMode').value === 'independent'){
    results.forEach(name=>{
      if(name in state.list) state.list[name] = Number(state.list[name]) * Number(state.multiplier);
    });
  }else{
    results.forEach(name=>{
      if(name in state.list) state.list[name] = Number(state.list[name]) * Number(state.multiplier);
    });
  }
  saveState();
}

function animateAndPick(count){
  const anim = state.animation || el('animationSelect').value;
  if(anim === 'roulette') return rouletteAnimation(count);
  return spinnerAnimation(count);
}

/* ======== Roulette (轮盘式) ======== */
function rouletteAnimation(count){
  const names = Object.keys(state.list);
  if(names.length === 0){ alert('名单为空'); return []; }
  const weights = names.map(n=> Number(state.list[n]));
  const total = weights.reduce((a,b)=>a+b,0) || names.length;
  const angles = weights.map(w=> (w/total)*360 );
  const results = pickSimulated(count, el('updateMode').value);
  const targetName = results[0] || names[0];

// 设置动画模态框内容
el('animationTitle').innerText = '轮盘抽选中...';
el('animationContent').innerHTML = `
  <div class="wheel-wrap">
    <div style="position:relative;">
      <div class="wheel" id="wheel" role="img" aria-label="轮盘"></div>
      <div class="wheel-pointer">
        <div class="wheel-pointer-label" id="wheelPointerLabel">${names[0]}</div>
      </div>
    </div>
    <div class="wheel-label-display" id="wheelLabel">${names[0]}</div>
  </div>
`;
  
  const wheel = el('wheel');
  const wheelLabel = el('wheelLabel');

  // 创建轮盘颜色
  const colors = ['#f97316','#f43f5e','#ef4444','#f59e0b','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#64748b'];
  let stops = [], cur = 0;
  for(let i=0;i<angles.length;i++){
    stops.push(`${colors[i % colors.length]} ${cur}deg ${cur+angles[i]}deg`);
    cur += angles[i];
  }
  wheel.style.background = `conic-gradient(${stops.join(',')})`;

  // 计算目标角度
  let acc = 0, targetCenter = 0;
  for(let i=0;i<names.length;i++){
    const a = angles[i];
    if(names[i] === targetName){
      targetCenter = acc + a/2;
      break;
    }
    acc += a;
  }

  // 旋转轮盘
  const spins = 6;
  const finalRotation = -(spins*360 + targetCenter);
  wheel.style.transformOrigin = '50% 50%';
  // 使用更明显的缓动函数，添加反弹效果
wheel.style.transition = `transform 3s cubic-bezier(0.34, 1.56, 0.64, 1)`;
  
  // 在动画过程中更新标签
  let startTime = Date.now();
  const duration = 3000;
  let animationFrame;
  
  function updateLabel(timestamp) {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(1, elapsed / duration);
    
    // 计算当前旋转角度
    const currentRotation = finalRotation * progress;
    
    // 计算当前指向的角度（0-360度）
    let currentAngle = (-currentRotation % 360 + 360) % 360;
    
    // 查找当前指向的名字
    let accumulated = 0;
    let currentName = names[0];
  for(let i=0;i<angles.length;i++){
    accumulated += angles[i];
    if(currentAngle <= accumulated || (i === names.length-1 && Math.abs(currentAngle - 360) < 0.001)){
      currentName = names[i];
      break;
    }
  }
    
    wheelLabel.innerText = currentName;
  el('wheelPointerLabel').innerText = currentName;
    
    if(progress < 1){
      animationFrame = requestAnimationFrame(updateLabel);
    }
  }
  
  return new Promise(resolve=>{
    // 开始动画
    void wheel.offsetWidth; // 强制重绘
    wheel.style.transform = `rotate(${finalRotation}deg)`;
    startTime = Date.now();
    animationFrame = requestAnimationFrame(updateLabel);
    
    setTimeout(()=>{
      cancelAnimationFrame(animationFrame);
      wheelLabel.innerText = targetName;
      applyPickedResults(results);
      
      // 显示最终结果
      setTimeout(()=>{
        closeAnimationModal();
        resolve(results);
      }, 800);
    }, duration + 200);
  });
}
/* ======== Legacy spinner ======== */
function spinnerAnimation(count){
  const names = Object.keys(state.list);
  if(names.length === 0){
    alert('名单为空');
    return [];
  }
  
  el('animationTitle').innerText = '随机抽选中...';
  el('animationContent').innerHTML = `
    <div class="animation-display" id="spinnerDisplay">${names[0]}</div>
  `;
  
  const display = el('spinnerDisplay');
  let lastIndex = 0;
  const duration = 3000;
  
  return new Promise(resolve=>{
    const startTime = Date.now();
    
    function updateSpinner() {
      const now = Date.now();
      const elapsed = now - startTime;
      const progress = Math.min(1, elapsed / duration);
      const speedFactor = 1 - Math.pow(progress, 3);
      const tick = 50 + Math.round(200 * speedFactor);
      
      lastIndex = (lastIndex + 1) % names.length;
      display.innerText = names[lastIndex];
      
      if(elapsed < duration){
        setTimeout(updateSpinner, tick);
      } else {
        const results = pickSimulated(count, el('updateMode').value);
        applyPickedResults(results);
        
        setTimeout(()=>{
          closeAnimationModal();
          resolve(results);
        }, 500);
      }
    }
    
    updateSpinner();
  });
}

/* ======== Drawing flow ======== */
async function doDraw(){
  const count = Math.max(1, Math.floor(Number(el('count').value) || 1));
  if(Object.keys(state.list).length === 0){
    alert('名单为空，无法抽取');
    return;
  }
  
  el('drawBtn').disabled = true;
  el('drawBtn').innerText = '抽取中...';
  
  try{
    // 显示动画模态框
    showAnimationModal();
    
    const results = await animateAndPick(count);
    
    // 保存历史记录
    state.history = state.history || [];
    state.history.push({time:Date.now(), results});
    saveState();
    renderHistory();
    
    // 显示结果模态框
    showModal(results);
    renderList(el('search').value.trim());
  }catch(err){
    console.error(err);
    alert('抽取发生错误');
  }finally{
    el('drawBtn').disabled = false;
    el('drawBtn').innerText = '开始抽取';
  }
}

/* ======== Modal functions ======== */
function showModal(results){
  const md = el('modal');
  const resultsDiv = el('modalResults');
  resultsDiv.innerHTML = '';
  results.forEach((r,i)=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.style.fontSize = '16px';
    chip.innerText = `${i+1}. ${r}`;
    resultsDiv.appendChild(chip);
  });
  md.style.display = 'flex';
}

function closeModal(){
  el('modal').style.display = 'none';
}

function showAnimationModal(){
  el('animationModal').style.display = 'flex';
}

function closeAnimationModal(){
  el('animationModal').style.display = 'none';
}

/* ======== Import/Export ======== */
function importFromTextarea(){
  const txt = el('importJson').value.trim();
  if(!txt) { alert('请输入 JSON'); return; }
  try{
    const obj = JSON.parse(txt);
    if(typeof obj !== 'object'){ alert('格式错误'); return; }
    state.list = {};
    Object.entries(obj).forEach(([k,v])=>{
      const num = Number(v);
      state.list[k] = isNaN(num) ? 0 : num;
    });
    saveState();
    renderList();
    alert('导入成功');
  }catch(e){
    alert('JSON 解析失败');
  }
}

function exportToTextarea(){
  el('importJson').value = JSON.stringify(state.list, null, 2);
}

function downloadJsonFile(){
  const data = JSON.stringify(state.list, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'name_list.json';
  a.click();
  URL.revokeObjectURL(url);
}

/* ======== Init & event bindings ======== */
function init(){
  const loadingEl = document.createElement('div');
  loadingEl.className = 'loading-overlay';
  loadingEl.innerHTML = `
    <div class="spinner">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  `;
  document.body.appendChild(loadingEl);
  
  loadState();
  // fill default json display
  el('defaultJson').innerText = JSON.stringify(DEFAULT_LIST, null, 2);
  el('defaultJson2').innerText = JSON.stringify(DEFAULT_LIST, null, 2);
  // initial UI values
  el('multiplier').value = state.multiplier;
el('animationSelect').value = 'roulette'; 
state.animation = 'roulette';
  state.animation = el('animationSelect').value;
  el('multiplierLabel').innerText = state.multiplier;
  renderList();
  renderHistory();

  // 页面加载完成后隐藏加载动画
  if (document.readyState === 'complete') {
    setTimeout(() => {
      loadingEl.classList.add('hidden');
      setTimeout(() => {
        if (document.body.contains(loadingEl)) {
          document.body.removeChild(loadingEl);
        }
      }, 300);
    }, 800);
  } else {
    window.addEventListener('load', () => {
      setTimeout(() => {
        loadingEl.classList.add('hidden');
        setTimeout(() => {
          if (document.body.contains(loadingEl)) {
            document.body.removeChild(loadingEl);
          }
        }, 300);
      }, 800);
    });
  }

  // events
  el('drawBtn').addEventListener('click', doDraw);
  el('advancedBtn').addEventListener('click', ()=> el('advancedPanel').style.display = 'block');
  el('closeAdvanced').addEventListener('click', ()=> el('advancedPanel').style.display = 'none');
  el('toggleDefault').addEventListener('click', ()=>{
    const d = el('defaultCollapsed');
    if(d.style.display === 'none'){ d.style.display = 'block'; el('toggleDefault').innerText = '折叠默认名单'; }
    else { d.style.display = 'none'; el('toggleDefault').innerText = '展开默认名单'; }
  });
  el('addBtn').addEventListener('click', ()=>{
    const name = el('newName').value.trim();
    let w = parseFloat(el('newWeight').value);
    if(!name){ alert('请输入名字'); return; }
    if(isNaN(w)) w = 1.0;
    state.list[name] = w;
    el('newName').value = '';
    el('newWeight').value = '1.0';
    saveState();
    renderList(el('search').value.trim());
  });
  el('resetDefault').addEventListener('click', ()=>{
    if(confirm('确定恢复默认名单吗？(会覆盖当前名单)')){
      state.list = {...DEFAULT_LIST};
      saveState();
      renderList();
    }
  });
  el('addSample').addEventListener('click', ()=>{
    const sampleName = '示例_' + Math.floor(Math.random()*1000);
    state.list[sampleName] = 1.0;
    saveState();
    renderList();
  });
  el('search').addEventListener('input', e=> renderList(e.target.value.trim()));
  el('multiplier').addEventListener('change', e=>{
    let v = parseFloat(e.target.value);
    if(isNaN(v) || v < 0) v = 0;
    if(v > 1) v = 1;
    state.multiplier = v;
    el('multiplierLabel').innerText = v;
    saveState();
  });
  el('animationSelect').addEventListener('change', e=>{
    state.animation = e.target.value;
    saveState();
  });
  el('importBtn').addEventListener('click', importFromTextarea);
  el('exportBtn').addEventListener('click', exportToTextarea);
  el('downloadBtn').addEventListener('click', downloadJsonFile);
  el('clearHistory').addEventListener('click', ()=> { state.history = []; saveState(); renderHistory(); });
  el('modal').addEventListener('click', (e)=> { if(e.target === el('modal')) closeModal(); });
  el('closeModal').addEventListener('click', closeModal);
  el('animationModal').addEventListener('click', (e)=> { if(e.target === el('animationModal')) closeAnimationModal(); });
  el('cancelAnimation').addEventListener('click', closeAnimationModal);
  
  // file input for JSON
  el('fileInput').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const obj = JSON.parse(ev.target.result);
        if(typeof obj !== 'object') { alert('格式错误'); return; }
        state.list = {};
        Object.entries(obj).forEach(([k,v])=>{
          const num = Number(v);
          state.list[k] = isNaN(num) ? 0 : num;
        });
        saveState();
        renderList();
        alert('导入成功');
      }catch(err){
        alert('JSON 解析失败');
      }
    };
    reader.readAsText(f);
  });

  // ensure UI animArea default
  el('animArea').innerHTML = `<div class="display-name" id="animName">准备就绪</div><div class="sub">点击"开始抽取"按钮进行抽选</div>`;
}

init();
</script>
</body>
</html>
