<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>权重随机抽人(MorningStarsX)</title>
<style>
/* ===== Global vars ===== */
:root{
  --accent:#2563eb;
  --muted:#6b7280;
  --bg:#ffffff;
  --card:#f8fafc;
  --radius:12px;
  --cooldown-color: #ef4444;
}
html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, "Helvetica Neue", Arial, sans-serif;color:#111827;}
.container{max-width:1100px;margin:28px auto;padding:20px;}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
h1{font-size:20px;margin:0}
.controls{display:flex;gap:8px;align-items:center;margin-top:8px;}

/* =====================
   Button style from Uiverse.io by Nawsome 
   ===================== */
.buttons {
  display: flex;
  justify-content: center;
  gap:12px;
  align-items:center;
}

.btn {
  width: 220px;
  height: 60px;
  background-color: white;
  color: #568fa6;
  position: relative;
  overflow: hidden;
  font-size: 14px;
  letter-spacing: 1px;
  font-weight: 700;
  text-transform: uppercase;
  transition: all 0.3s ease;
  cursor: pointer;
  border: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
}

.btn:before, .btn:after {
  content: "";
  position: absolute;
  width: 0;
  height: 2px;
  background-color: #44d8a4;
  transition: all 0.3s cubic-bezier(0.35, 0.1, 0.25, 1);
}

.btn:before {
  right: 0;
  top: 0;
  transition: all 0.5s cubic-bezier(0.35, 0.1, 0.25, 1);
}

.btn:after {
  left: 0;
  bottom: 0;
}

.btn span {
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  margin: 0;
  padding: 0;
  z-index: 1;
}

.btn span:before, .btn span:after {
  content: "";
  position: absolute;
  width: 2px;
  height: 0;
  background-color: #44d8a4;
  transition: all 0.3s cubic-bezier(0.35, 0.1, 0.25, 1);
}

.btn span:before {
  right: 0;
  top: 0;
  transition: all 0.5s cubic-bezier(0.35, 0.1, 0.25, 1);
}

.btn span:after {
  left: 0;
  bottom: 0;
}

.btn p {
  padding: 0;
  margin: 0;
  transition: all 0.4s cubic-bezier(0.35, 0.1, 0.25, 1);
  position: absolute;
  width: 100%;
  height: 100%;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2;
  pointer-events:none;
}

.btn p:before, .btn p:after {
  position: absolute;
  width: 100%;
  transition: all 0.4s cubic-bezier(0.35, 0.1, 0.25, 1);
  z-index: 1;
  left: 0;
}

.btn p:before {
  content: attr(data-title);
  top: 50%;
  transform: translateY(-50%);
  color: #111827;
}

.btn p:after {
  content: attr(data-text);
  top: 150%;
  color: #44d8a4;
}

.btn:hover:before, .btn:hover:after {
  width: 100%;
}

.btn:hover span {
  z-index: 1;
}

.btn:hover span:before, .btn:hover span:after {
  height: 100%;
}

.btn:hover p:before {
  top: -50%;
  transform: rotate(5deg);
}

.btn:hover p:after {
  top: 50%;
  transform: translateY(-50%);
}

/* start state */
.btn.start {
  background-color: #44d8a4;
  color: #fff;
  box-shadow: 0px 5px 10px -10px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.btn.start p:before {
  top: -50%;
  transform: rotate(5deg);
}

.btn.start p:after {
  color: white;
  transition: all 0s ease;
  content: attr(data-start);
  top: 50%;
  transform: translateY(-50%);
  animation: start 0.3s ease;
  animation-fill-mode: forwards;
}

@keyframes start {
  from { top: -50%; }
}

.btn.start:hover:before, .btn.start:hover:after {
  display: none;
}

.btn.start:hover span { display: none; }

.btn:active { outline:none; border:none; }
.btn:focus { outline:0; }

/* =====================
   Loader style -> 样式2 (andrew-manzyk)
   ===================== */
.loader {
  --color-one: #ffbf48;
  --color-two: #be4a1d;
  --color-three: #ffbf4780;
  --color-four: #bf4a1d80;
  --color-five: #ffbf4740;
  --time-animation: 2s;
  --size: 1;
  position: relative;
  border-radius: 50%;
  transform: scale(var(--size));
  box-shadow:
    0 0 25px 0 var(--color-three),
    0 20px 50px 0 var(--color-four);
  animation: colorize calc(var(--time-animation) * 3) ease-in-out infinite;
}

.loader::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border-top: solid 1px var(--color-one);
  border-bottom: solid 1px var(--color-two);
  background: linear-gradient(180deg, var(--color-five), var(--color-four));
  box-shadow:
    inset 0 10px 10px 0 var(--color-three),
    inset 0 -10px 10px 0 var(--color-four);
}

.loader .box {
  width: 100px;
  height: 100px;
  background: linear-gradient(
    180deg,
    var(--color-one) 30%,
    var(--color-two) 70%
  );
  mask: url(#clipping);
  -webkit-mask: url(#clipping);
}

.loader svg {
  position: absolute;
  width: 100px;
  height: 100px;
}

.loader svg #clipping {
  filter: contrast(15);
  animation: roundness calc(var(--time-animation) / 2) linear infinite;
}

.loader svg #clipping polygon {
  filter: blur(7px);
}

.loader svg #clipping polygon:nth-child(1) {
  transform-origin: 75% 25%;
  transform: rotate(90deg);
}

.loader svg #clipping polygon:nth-child(2) {
  transform-origin: 50% 50%;
  animation: rotation var(--time-animation) linear infinite reverse;
}

.loader svg #clipping polygon:nth-child(3) {
  transform-origin: 50% 60%;
  animation: rotation var(--time-animation) linear infinite;
  animation-delay: calc(var(--time-animation) / -3);
}

.loader svg #clipping polygon:nth-child(4) {
  transform-origin: 40% 40%;
  animation: rotation var(--time-animation) linear infinite reverse;
}

.loader svg #clipping polygon:nth-child(5) {
  transform-origin: 40% 40%;
  animation: rotation var(--time-animation) linear infinite reverse;
  animation-delay: calc(var(--time-animation) / -2);
}

.loader svg #clipping polygon:nth-child(6) {
  transform-origin: 60% 40%;
  animation: rotation var(--time-animation) linear infinite;
}

.loader svg #clipping polygon:nth-child(7) {
  transform-origin: 60% 40%;
  animation: rotation var(--time-animation) linear infinite;
  animation-delay: calc(var(--time-animation) / -1.5);
}

@keyframes rotation { 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
@keyframes roundness { 0%{ filter: contrast(15);} 20%{ filter: contrast(3);} 40%{ filter: contrast(3);} 60%{ filter: contrast(15);} 100%{ filter: contrast(15);} }
@keyframes colorize { 0%{ filter: hue-rotate(0deg);} 20%{ filter: hue-rotate(-30deg);} 40%{ filter: hue-rotate(-60deg);} 60%{ filter: hue-rotate(-90deg);} 80%{ filter: hue-rotate(-45deg);} 100%{ filter: hue-rotate(0deg);} }

/* Loading overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(255,255,255,0.9);
  display:flex;align-items:center;justify-content:center;z-index:9999;
  transition: opacity 2s ease;
}
.loading-overlay.hidden { opacity:0; pointer-events:none; }

/* =====================
   UI layout & other buttons (sizes adjusted)
   ===================== */
button.ghost{--border-radius:13px;--border-width:4px;appearance:none;position:relative;padding:0.5em 1.0em;border:0;background-color:#f8fafc;font-family:"Roboto",Arial,"Segoe UI",sans-serif;font-size:13px;font-weight:600;color:#212121;z-index:2;border-radius:8px;min-width:84px;}
.icon-btn{--border-radius:8px;--border-width:2px;appearance:none;position:relative;padding:6px 10px;border:0;background-color:#f8fafc;font-family:"Roboto",Arial,"Segoe UI",sans-serif;font-size:13px;font-weight:600;color:#212121;z-index:2;min-width:44px;text-align:center;border-radius:8px;}
.primary-large{display:none;} /* replaced by .btn in UI */

.card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(12,20,30,0.04);}
.layout{display:grid;grid-template-columns:360px 1fr;gap:18px;}
.left{display:flex;flex-direction:column;gap:12px}
.list-header{display:flex;justify-content:space-between;align-items:center}
.fold-toggle{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px}
.name-list{max-height:340px;overflow:auto;padding:8px;border-radius:10px;background:#fff;border:1px solid #eef2ff}
.list-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;margin-bottom:6px}
.list-row:hover{background:#f1f5f9}
.name{font-weight:600}
.weight{font-size:13px;color:var(--muted);margin-left:12px}
.small{font-size:13px;color:var(--muted)}
.actions{display:flex;gap:6px;align-items:center}
.input { padding: 0.75rem; font-size: 1rem; border: 1.5px solid #000; border-radius: 0.5rem; box-shadow: 2.5px 3px 0 #000; outline: none; transition: ease 0.25s; flex: 1; }
.input:focus{ box-shadow: 5.5px 7px 0 black;}

/* right panel */
.right{display:flex;flex-direction:column;gap:12px}
.config{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.config > *{flex:1;min-width:200px;}
.big-display{height:220px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#f8fbff);display:flex;align-items:center;justify-content:center;flex-direction:column;border:1px dashed #e6eefc;position:relative;}

/* display name removed - start button will be here instead */

/* history */
#historyList{margin-top:8px;max-height:180px;overflow:auto;padding:8px;border-radius:8px;background:#fff;border:1px solid #eef2ff;display:flex;flex-direction:column;gap:6px;}
.history-compact .chip{font-size:12px;padding:6px 8px;border-radius:999px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.history-expanded .chip{font-size:14px;padding:8px 10px;border-radius:8px;display:inline-block;max-width:100%;}

/* chips */
.chip{background:white;padding:8px 12px;border-radius:999px;border:1px solid #eef2ff;font-weight:600;display:inline-block;margin-right:6px;margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px;}

/* name cooldown indicator */
.cooldown-tag{display:inline-block;background:var(--cooldown-color);color:white;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:8px;animation: pulse 2s infinite;}

@keyframes pulse {
  0% { opacity: 0.7; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}

/* wheel / roulette styles */
.wheel-wrap{display:flex;justify-content:center;align-items:center;gap:20px;flex-direction:row;position:relative}
.wheel{width:280px;height:280px;border-radius:50%;position:relative;overflow:hidden;border:6px solid #fff;box-shadow:0 8px 22px rgba(2,6,23,0.06);transform-origin:center center;transition:transform 3s cubic-bezier(0.34, 1.56, 0.64, 1);}
.wheel .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;font-weight:700}
.wheel-label-display{font-size:24px;font-weight:700;color:#111827;min-width:120px;text-align:center;padding:12px;border-radius:12px;background:#f8fafc;border:2px solid #eef2ff;}
.wheel-pointer { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); z-index: 10; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); display: flex; flex-direction: column; align-items: center; }
.wheel-pointer::before { content: ""; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #ef4444; margin-bottom: 2px; }
.wheel-pointer::after { content: ""; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 20px solid #ef4444; }
.wheel-pointer-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: #ef4444; border: 1px solid #ef4444; white-space: nowrap; z-index: 11;}

/* Modal styles */
.modal-backdrop {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, background 0.3s ease, visibility 0.3s ease;
}

.modal-backdrop[style*="display: flex"] {
  opacity: 1;
  visibility: visible;
  background: rgba(0,0,0,0.5);
}

.modal {
  background: white;
  padding: 24px;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  transform: scale(0.9);
  opacity: 0;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
}

.modal-backdrop[style*="display: flex"] .modal {
  transform: scale(1);
  opacity: 1;
}

.animation-modal {
  background: white;
  padding: 24px;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  transform: scale(0.9);
  opacity: 0;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
}

.modal-backdrop[style*="display: flex"] .animation-modal {
  transform: scale(1);
  opacity: 1;
}

.modal {
  background: white;
  padding: 24px;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.animation-modal {
  background: white;
  padding: 24px;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

/* Add row */
.add-row {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  align-items: center;
}

.add-row input {
  flex: 1;
  padding: 8px;
  border: 1px solid #e6eefc;
  border-radius: 8px;
}

/* footer */
footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  padding: 12px 0;
  border-top: 1px solid #eef2ff;
}

/* responsive */
@media (max-width:880px){
  .layout{grid-template-columns:1fr;}
  .left{order:2}
  .animation-modal{min-width:90%;padding:16px;}
  .big-display{height:180px}
  .btn{width:200px;height:50px;font-size:13px}
  .wheel{width:220px;height:220px}
  .wheel-wrap{flex-direction:column;}
  .config > *{min-width:100%;}
  header{flex-direction:column;align-items:flex-start;}
  .controls{width:100%;justify-content:flex-start;}
}

@media (max-width:480px){
  .container{padding:12px;}
  .btn{width:180px;height:48px;font-size:12px;}
  .wheel{width:200px;height:200px;}
  .add-row{flex-direction:column;}
  .add-row input{width:100%;}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>权重随机抽人器By-MorningStarsX</h1>
      <div class="small">初始权重 1.0 · 抽中后权重 × <span id="multiplierLabel">0.4</span></div>
    </div>
    <div class="controls">
      <button id="advancedBtn" class="ghost">高级设置</button>
    </div>
  </header>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div class="list-header">
          <strong>名单(折叠)</strong>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="fold-toggle" id="toggleDefault">展开默认名单</button>
          </div>
        </div>

        <div id="defaultCollapsed" style="display:none;margin-top:10px;">
          <div class="json-area" id="defaultJson"></div>
        </div>

        <div style="height:8px"></div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="search" placeholder="搜索名字" class="input">
          <button id="addSample" class="icon-btn" title="添加示例">＋</button>
          <button id="resetDefault" class="icon-btn" title="恢复默认">↺</button>
        </div>

        <div class="name-list" id="nameList"></div>

        <div class="add-row">
          <input id="newName" placeholder="新名字" />
          <input id="newWeight" type="number" step="0.1" value="1.0" style="width:86px" />
          <button id="addBtn" class="icon-btn">添加</button>
        </div>
      </div>

      <div class="advanced-panel card" id="advancedPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>高级设置</strong>
          <button id="closeAdvanced" class="ghost">关闭</button>
        </div>

        <div style="margin-top:10px;display:grid;gap:8px">
          <label>权重更新量(抽中后乘以)</label>
          <input id="multiplier" type="number" step="0.01" min="0" max="1" value="0.4" />

          <label>抽取动画</label>
          <select id="animationSelect">
            <option value="roulette">轮盘式 (Roulette)</option>
            <option value="spinner">简单滚动 (Spinner)</option>
          </select>

          <label>抽取冷却(秒)</label>
          <input id="cooldownSeconds" type="number" value="30" min="0" style="width:120px" />

          <label>导入名单(JSON 格式：{"名字":1.0, ...})</label>
          <textarea id="importJson" placeholder='{"张三":1.0, "李四":1.0}' rows="4" style="padding:8px;border-radius:8px;border:1px solid #e6eefc"></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="importBtn" class="ghost">导入名单</button>
            <button id="exportBtn" class="ghost">导出名单</button>
            <button id="downloadBtn" class="ghost">下载 JSON 文件</button>
            <input type="file" id="fileInput" accept=".json" style="display:none" />
          </div>
        </div>
      </div>

    </div>

    <div class="right">
      <div class="card config">
        <div>
          <label>抽取数量(1 = 单人)</label>
          <input id="count" type="number" value="1" min="1" style="width:120px" />
        </div>
        <div>
          <label>是否按顺序更新权重</label>
          <select id="updateMode" style="width:160px">
            <option value="sequential">顺序更新(每次抽后立即更新,影响下一次抽)</option>
            <option value="independent">独立抽取(基于初始权重,同次抽取互不影响)</option>
          </select>
        </div>
      </div>

      <div class="big-display card" id="bigDisplay">
        <div class="buttons">
          <button id="drawBtn" class="btn"><span></span><p data-start="good luck!" data-text="start!" data-title="开始抽取"></p></button>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
          <strong>最近抽取结果</strong>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
            <button id="toggleHistoryStyle" class="ghost">切换显示风格</button>
            <button id="clearHistory" class="ghost">清除</button>
          </div>
        </div>
        <div id="historyList" class="history-compact"></div>
      </div>

      <footer>
        <div>当前总人数：<span id="totalCount">0</span></div>
        <div class="small">数据保存在本地</div>
      </footer>
    </div>
  </div>
</div>

<!-- result modal -->
<div class="modal-backdrop" id="modal" style="display:none;">
  <div class="modal">
    <h3>抽取结果</h3>
    <div class="result-list" id="modalResults"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="closeModal" class="ghost">关闭</button>
    </div>
  </div>
</div>

<!-- animation modal -->
<div class="modal-backdrop" id="animationModal" style="display:none;">
  <div class="animation-modal">
    <h3 id="animationTitle">抽取动画</h3>
    <div class="animation-content" id="animationContent">
      <!-- 转盘动画将在这里动态生成 -->
    </div>
    <div style="margin-top:20px;">
      <button id="cancelAnimation" class="ghost">取消</button>
    </div>
  </div>
</div>

<!-- loading overlay (uses loader style2) -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="loader" aria-hidden="true">
    <svg width="100" height="100" viewBox="0 0 100 100" aria-hidden="true">
      <defs>
        <mask id="clipping">
          <polygon points="0,0 100,0 100,100 0,100" fill="black"></polygon>
          <polygon points="25,25 75,25 50,75" fill="white"></polygon>
          <polygon points="50,25 75,75 25,75" fill="white"></polygon>
          <polygon points="35,35 65,35 50,65" fill="white"></polygon>
          <polygon points="35,35 65,35 50,65" fill="white"></polygon>
          <polygon points="35,35 65,35 50,65" fill="white"></polygon>
          <polygon points="35,35 65,35 50,65" fill="white"></polygon>
        </mask>
      </defs>
    </svg>
    <div class="box"></div>
  </div>
</div>

<script>
/* ======== 默认名单(2027届17班) ======== */
const DEFAULT_LIST = {
"曾佳怡":1.0, "陈凯":1.0, "陈俐肜":1.0, "陈芋雄":1.0, "陈哲宇":1.0, "陈子萓":1.0, "邓蓉清":1.0, "杜韦鹏":1.0, "方毅":1.0, "符丰牧":1.0,
"符智晨":1.0, "黄艳萍":1.0, "黄志威":1.0, "揭弘毅":1.0, "揭子尧":1.0, "赖聪":1.0, "赖婷":1.0, "赖亚宁":1.0, "赖雨欣":1.0, "赖钰玲":1.0,
"李诚铚":1.0, "李华珍":1.0, "李惠东":1.0, "李哲聪":1.0, "廖鸿瑞":1.0, "廖俊":1.0, "刘扬":1.0, "刘艺":1.0, "马哲灏":1.0, "聂娅馨":1.0,
"瞿世浓":1.0, "饶俊彦":1.0, "饶淑玲":1.0, "饶文垒":1.0, "饶咏坤":1.0, "魏如俊":1.0, "魏志雄":1.0, "魏智萱":1.0, "温粤凡":1.0, "吴博宇":1.0,
"吴海艳":1.0, "吴和兴":1.0, "夏浩轩":1.0, "夏禹豪":1.0, "肖志远":1.0, "谢佳童":1.0, "谢近哲":1.0, "谢雨欣":1.0, "幸天睿":1.0, "熊宇勋":1.0,
"徐子豪":1.0, "杨嘉琦":1.0, "叶丹":1.0, "余凡":1.0, "余梦瑶":1.0
};

/* ======== State & helpers ======== */
let state = {
  list: {}, // {name: weight}
  multiplier: 0.4,
  animation: 'roulette',
  history: [],
  cooldowns: {}, // name -> timestamp(ms) until which name is on cooldown
  cooldownSeconds: 30,
  historyCompact: true
};

const el = id => document.getElementById(id);
let cooldownTimer = null; // 冷却定时器

/* Load state from localStorage if present, otherwise fallback to defaults. */
function loadState(){
  try{
    const raw = localStorage.getItem('weighted_draw_state_v1');
    if(raw){
      const parsed = JSON.parse(raw);
      state = Object.assign(state, parsed);
      // ensure required fields exist
      state.list = state.list || {...DEFAULT_LIST};
      state.history = state.history || [];
      state.cooldowns = state.cooldowns || {};
      state.multiplier = typeof state.multiplier === 'number' ? state.multiplier : 0.4;
      state.cooldownSeconds = state.cooldownSeconds || 10;
      state.animation = state.animation || 'roulette';
      
      // 每次加载页面时重置所有人的权重为1.0
      Object.keys(state.list).forEach(name => {
        state.list[name] = 1.0;
      });
    }else{
      // first run: use default
      state.list = {...DEFAULT_LIST};
      state.history = [];
      state.multiplier = 0.4;
      state.cooldowns = {};
      state.cooldownSeconds = 30;
      state.animation = 'roulette';
    }
    saveState();
  }catch(e){
    console.warn('加载状态出错:', e);
    state.list = {...DEFAULT_LIST};
    state.history = [];
    state.multiplier = 0.4;
    state.cooldowns = {};
    state.cooldownSeconds = 30;
    state.animation = 'roulette';
    saveState();
  }
}

function saveState(){
  try{
    localStorage.setItem('weighted_draw_state_v1', JSON.stringify(state));
  }catch(e){
    console.warn('保存状态失败', e);
  }
}

/* helper: check if a name is on cooldown (returns remaining seconds) */
function getCooldownRemaining(name){
  const until = state.cooldowns[name];
  if(!until) return 0;
  const remain = Math.max(0, Math.ceil((until - Date.now())/1000));
  if(remain === 0) { 
    delete state.cooldowns[name]; 
    saveState(); 
    return 0; 
  }
  return remain;
}

/* 启动冷却计时器 */
function startCooldownTimer() {
  if (cooldownTimer) clearInterval(cooldownTimer);
  cooldownTimer = setInterval(() => {
    const filter = el('search').value.trim();
    renderList(filter);
  }, 1000);
}

/* ======== UI 渲染 ======== */
function renderList(filter=''){
  const container = el('nameList');
  container.innerHTML = '';
  const entries = Object.entries(state.list).sort((a,b)=> b[1]-a[1]);
  entries.filter(([n])=> n.toLowerCase().includes(filter.toLowerCase())).forEach(([name, w])=>{
    const row = document.createElement('div');
    row.className = 'list-row';
    const cooldown = getCooldownRemaining(name);
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="name">${name}</div>
        ${ cooldown ? `<span class="cooldown-tag">冷却 ${cooldown}s</span>` : `<div class="weight">权重 ${Number(w).toFixed(3)}</div>` }
      </div>
      <div class="actions">
        <input type="number" step="0.1" value="${w}" style="width:88px;padding:6px;border-radius:8px;border:1px solid #e6eefc" data-name="${name}" class="editWeight"/>
        <button class="icon-btn" data-name="${name}" data-action="del">删除</button>
      </div>
    `;
    container.appendChild(row);
  });
  el('totalCount').innerText = Object.keys(state.list).length;
  // attach edit handlers
  document.querySelectorAll('.editWeight').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const n = e.target.dataset.name;
      let v = parseFloat(e.target.value);
      if(isNaN(v) || v < 0) v = 0;
      state.list[n] = v;
      saveState();
      renderList(el('search').value.trim());
    });
  });
  document.querySelectorAll('button[data-action="del"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const name = e.currentTarget.dataset.name;
      if(confirm('删除 ' + name + ' ?')){
        delete state.list[name];
        delete state.cooldowns[name];
        saveState();
        renderList(el('search').value.trim());
      }
    });
  });
}

function renderHistory(){
  const box = el('historyList');
  box.innerHTML = '';
  if(state.historyCompact){
    box.className = 'history-compact';
  }else{
    box.className = 'history-expanded';
  }
  for(let i=state.history.length-1;i>=0;i--){
    const rec = state.history[i];
    const d = new Date(rec.time).toLocaleString();
    const container = document.createElement('div');
    container.style.display='flex';
    container.style.flexDirection='column';
    const meta = document.createElement('div');
    meta.className='small';
    meta.style.marginBottom='6px';
    meta.innerHTML = `<strong>${d}</strong>`;
    container.appendChild(meta);
    const row = document.createElement('div');
    row.style.display='flex';
    row.style.flexWrap='wrap';
    row.style.gap='6px';
    rec.results.forEach((r, idx)=>{
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.style.fontSize = state.historyCompact ? '12px' : '14px';
      chip.innerText = `${idx+1}. ${r}`;
      row.appendChild(chip);
    });
    container.appendChild(row);
    box.appendChild(container);
  }
}

/* ======== Weighted random pick helpers (respect cooldowns) ======== */
function getEligibleList(listObj){
  const now = Date.now();
  const eligible = {};
  for(const [k,v] of Object.entries(listObj)){
    const until = state.cooldowns[k] || 0;
    if(now >= until && Number(v) > 0){
      eligible[k] = Number(v);
    }
  }
  return eligible;
}

function weightedPickOnce(listObj){
  const names = Object.keys(listObj);
  const weights = names.map(n=> Number(listObj[n]) );
  const total = weights.reduce((a,b)=>a+b,0);
  if(total <= 0) return null;
  const rnd = Math.random() * total;
  let s = 0;
  for(let i=0;i<names.length;i++){
    s += weights[i];
    if(rnd <= s) return names[i];
  }
  return names[names.length-1];
}

function pickMultiple(count, mode='sequential'){
  const results = [];
  // base source is state.list but we must respect cooldowns -> create eligible copy
  let tempList = getEligibleList(state.list);
  if(Object.keys(tempList).length === 0) return results;
  if(mode === 'independent'){
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(tempList);
      if(!pick) break;
      results.push(pick);
    }
    // apply multipliers to actual state and set cooldowns
    results.forEach(name=>{
      if(name in state.list){
        state.list[name] = Number(state.list[name]) * Number(state.multiplier);
        // set cooldown
        if(Number(state.cooldownSeconds) > 0){
          state.cooldowns[name] = Date.now() + Number(state.cooldownSeconds)*1000;
        }
      }
    });
    saveState();
    return results;
  }else{
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(tempList);
      if(!pick) break;
      results.push(pick);
      // update tempList for sequential mode
      tempList[pick] = Number(tempList[pick]) * Number(state.multiplier);
    }
    // apply updates to actual state and cooldowns in the order of results
    results.forEach(name=>{
      if(name in state.list){
        state.list[name] = Number(state.list[name]) * Number(state.multiplier);
        if(Number(state.cooldownSeconds) > 0){
          state.cooldowns[name] = Date.now() + Number(state.cooldownSeconds)*1000;
        }
      }
    });
    saveState();
    return results;
  }
}

/* pickSimulated used by animations - uses same logic (respects cooldowns) */
function pickSimulated(count, mode){
  const original = {...state.list};
  const eligibleBase = getEligibleList(original);
  const names = Object.keys(eligibleBase);
  if(names.length === 0) return [];
  if(mode === 'independent'){
    const results = [];
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(eligibleBase);
      if(!pick) break;
      results.push(pick);
    }
    return results;
  }else{
    const results = [];
    const temp = {...eligibleBase};
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(temp);
      if(!pick) break;
      results.push(pick);
      temp[pick] = Number(temp[pick]) * Number(state.multiplier);
    }
    return results;
  }
}

/* applyPickedResults kept for compatibility with some flows */
function applyPickedResults(results){
  if(!results || results.length===0) return;
  results.forEach(name=>{
    if(name in state.list){
      state.list[name] = Number(state.list[name]) * Number(state.multiplier);
      if(Number(state.cooldownSeconds) > 0){
        state.cooldowns[name] = Date.now() + Number(state.cooldownSeconds)*1000;
      }
    }
  });
  saveState();
}

/* ======== Animation implementations ======== */
function animateAndPick(count){
  const anim = state.animation || el('animationSelect').value;
  if(anim === 'roulette') return rouletteAnimation(count);
  return spinnerAnimation(count);
}

/* Roulette animation */
function rouletteAnimation(count){
  const namesAll = Object.keys(state.list);
  const eligible = Object.entries(getEligibleList(state.list)).map(e=>e[0]);
  if(eligible.length === 0){ alert('没有可用的候选人(可能都在冷却或权重为0)'); return []; }
  const results = pickSimulated(count, el('updateMode').value);
  const targetName = results[0] || eligible[0];

  el('animationTitle').innerText = '轮盘抽选中...';
  
  // 在弹窗中显示转盘
  el('animationContent').innerHTML = `
    <div class="wheel-wrap">
      <div style="position:relative;">
        <div class="wheel" id="wheel" role="img" aria-label="轮盘"></div>
        <div class="wheel-pointer">
          <div class="wheel-pointer-label" id="wheelPointerLabel">${eligible[0]}</div>
        </div>
      </div>
      <div class="wheel-label-display" id="wheelLabel">${eligible[0]}</div>
    </div>
  `;

  const wheel = el('wheel');
  const wheelLabel = el('wheelLabel');

  // build angles based on eligible only
  const weights = []; const names = [];
  const eligibleObj = getEligibleList(state.list);
  Object.entries(eligibleObj).forEach(([n,w])=>{ names.push(n); weights.push(Number(w)); });
  const total = weights.reduce((a,b)=>a+b,0) || names.length;
  const angles = weights.map(w=> (w/total)*360 );

  const colors = ['#f97316','#f43f5e','#ef4444','#f59e0b','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#64748b'];
  let stops = [], cur = 0;
  for(let i=0;i<angles.length;i++){
    stops.push(`${colors[i % colors.length]} ${cur}deg ${cur+angles[i]}deg`);
    cur += angles[i];
  }
  wheel.style.background = `conic-gradient(${stops.join(',')})`;

  // compute final rotation to land on targetName
  let acc = 0, targetCenter = 0;
  for(let i=0;i<names.length;i++){
    const a = angles[i];
    if(names[i] === targetName){
      targetCenter = acc + a/2;
      break;
    }
    acc += a;
  }

  const spins = 6;
  const finalRotation = -(spins*360 + targetCenter);
  wheel.style.transformOrigin = '50% 50%';
  wheel.style.transition = `transform 3s cubic-bezier(0.34, 1.56, 0.64, 1)`;
  
  // animation label update
  let startTime = Date.now();
  const duration = 3000;
  let animationFrame;

  function updateLabel(){
    const elapsed = Date.now() - startTime;
    const progress = Math.min(1, elapsed / duration);
    const currentRotation = finalRotation * progress;
    let currentAngle = (-currentRotation % 360 + 360) % 360;
    let accumulated = 0;
    let currentName = names[0];
    for(let i=0;i<angles.length;i++){
      accumulated += angles[i];
      if(currentAngle <= accumulated || (i === names.length-1 && Math.abs(currentAngle - 360) < 0.001)){
        currentName = names[i];
        break;
      }
    }
    wheelLabel.innerText = currentName;
    const wp = el('wheelPointerLabel');
    if(wp) wp.innerText = currentName;
    if(progress < 1){
      animationFrame = requestAnimationFrame(updateLabel);
    }
  }

  return new Promise(resolve=>{
    void wheel.offsetWidth;
    wheel.style.transform = `rotate(${finalRotation}deg)`;
    startTime = Date.now();
    animationFrame = requestAnimationFrame(updateLabel);

    setTimeout(()=>{
      cancelAnimationFrame(animationFrame);
      wheelLabel.innerText = targetName;
      applyPickedResults(results);

      setTimeout(()=>{
        closeAnimationModal();
        resolve(results);
      }, 800);
    }, duration + 200);
  });
}

/* spinner animation (legacy) */
function spinnerAnimation(count){
  const eligible = Object.keys(getEligibleList(state.list));
  if(eligible.length === 0){ alert('没有可用的候选人(可能都在冷却或权重为0)'); return []; }
  el('animationTitle').innerText = '随机抽选中...';
  el('animationContent').innerHTML = `
    <div class="animation-display" id="spinnerDisplay">${eligible[0]}</div>
  `;
  const display = el('spinnerDisplay');
  let lastIndex = 0;
  const duration = 3000;
  return new Promise(resolve=>{
    const startTime = Date.now();
    function updateSpinner(){
      const now = Date.now();
      const elapsed = now - startTime;
      const progress = Math.min(1, elapsed / duration);
      const speedFactor = 1 - Math.pow(progress, 3);
      const tick = 50 + Math.round(200 * speedFactor);
      lastIndex = (lastIndex + 1) % eligible.length;
      display.innerText = eligible[lastIndex];
      if(elapsed < duration){
        setTimeout(updateSpinner, tick);
      } else {
        const results = pickSimulated(count, el('updateMode').value);
        applyPickedResults(results);
        setTimeout(()=>{ closeAnimationModal(); resolve(results); }, 500);
      }
    }
    updateSpinner();
  });
}

/* ======== Drawing flow ======== */
async function doDraw(){
  const count = Math.max(1, Math.floor(Number(el('count').value) || 1));
  if(Object.keys(state.list).length === 0){
    alert('名单为空,无法抽取');
    return;
  }

  const drawBtn = el('drawBtn');
  const pElement = drawBtn.querySelector('p');
  
  // 保存原始数据属性
  const originalStart = pElement.getAttribute('data-start');
  const originalText = pElement.getAttribute('data-text');
  const originalTitle = pElement.getAttribute('data-title');
  
  // 修改按钮状态 - 使用正确的CSS类方式
  drawBtn.disabled = true;
  drawBtn.classList.add('start');
  pElement.setAttribute('data-start', '抽取中...');
  pElement.setAttribute('data-text', '抽取中...');
  pElement.setAttribute('data-title', '抽取中...');

  try{
    showAnimationModal();
    const results = await animateAndPick(count);

    // 保存历史记录
    state.history = state.history || [];
    state.history.push({time:Date.now(), results});
    saveState();
    renderHistory();

    // 显示结果模态框
    showModal(results);
    renderList(el('search').value.trim());
  }catch(err){
    console.error(err);
    alert('抽取发生错误');
  }finally{
    // 恢复按钮状态
    drawBtn.disabled = false;
    drawBtn.classList.remove('start');
    pElement.setAttribute('data-start', originalStart);
    pElement.setAttribute('data-text', originalText);
    pElement.setAttribute('data-title', originalTitle);
    
    // ensure UI updated
    renderList(el('search').value.trim());
    renderHistory();
  }
}

/* ======== Modal functions ======== */
function showModal(results){
  const md = el('modal');
  const resultsDiv = el('modalResults');
  resultsDiv.innerHTML = '';
  results.forEach((r,i)=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.style.fontSize = '16px';
    chip.innerText = `${i+1}. ${r}`;
    resultsDiv.appendChild(chip);
  });
  
  // 强制重绘以确保动画正确执行
  void md.offsetWidth;
  md.style.display = 'flex';
  
  // 短暂延迟以确保display:flex已应用
  setTimeout(() => {
    md.style.opacity = '1';
  }, 10);
}

function closeModal(){ 
  const md = el('modal');
  md.style.opacity = '0';
  setTimeout(() => {
    md.style.display = 'none';
  }, 300);
}

function showAnimationModal(){ 
  const am = el('animationModal');
  // 强制重绘以确保动画正确执行
  void am.offsetWidth;
  am.style.display = 'flex';
  
  // 短暂延迟以确保display:flex已应用
  setTimeout(() => {
    am.style.opacity = '1';
  }, 10);
}

function closeAnimationModal(){ 
  const am = el('animationModal');
  am.style.opacity = '0';
  setTimeout(() => {
    am.style.display = 'none';
  }, 300);
}

/* ======== Import/Export ======== */
function importFromTextarea(){
  const txt = el('importJson').value.trim();
  if(!txt) { alert('请输入 JSON'); return; }
  try{
    const obj = JSON.parse(txt);
    if(typeof obj !== 'object'){ alert('格式错误'); return; }
    state.list = {};
    Object.entries(obj).forEach(([k,v])=>{
      const num = Number(v);
      state.list[k] = isNaN(num) ? 0 : num;
    });
    saveState();
    renderList();
    alert('导入成功');
  }catch(e){
    alert('JSON 解析失败');
  }
}

function exportToTextarea(){
  el('importJson').value = JSON.stringify(state.list, null, 2);
}

function downloadJsonFile(){
  const data = JSON.stringify(state.list, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'name_list.json';
  a.click();
  URL.revokeObjectURL(url);
}

/* ======== Init & event bindings ======== */
function init(){
  // show minimal loading overlay while init
  const loadingEl = el('loadingOverlay');
  loadingEl.style.display = 'flex';

  loadState();

  // fill default json display
  el('defaultJson').innerText = JSON.stringify(DEFAULT_LIST, null, 2);
  // 移除第二个默认名单显示,避免重复

  // apply saved settings to UI
  el('multiplier').value = state.multiplier;
  el('animationSelect').value = state.animation || 'roulette';
  el('cooldownSeconds').value = state.cooldownSeconds || 10;
  el('multiplierLabel').innerText = state.multiplier;
  el('animationSelect').value = state.animation || 'roulette';
  renderList();
  renderHistory();
  
  // 启动冷却计时器
  startCooldownTimer();
  
  // hide loading overlay after small delay
  setTimeout(()=>{ loadingEl.classList.add('hidden'); setTimeout(()=>{ loadingEl.style.display='none'; },300); }, 2000);

  // events
  el('drawBtn').addEventListener('click', doDraw);
  el('advancedBtn').addEventListener('click', ()=> el('advancedPanel').style.display = 'block');
  el('closeAdvanced').addEventListener('click', ()=> el('advancedPanel').style.display = 'none');
  el('toggleDefault').addEventListener('click', ()=>{
    const d = el('defaultCollapsed');
    if(d.style.display === 'none'){ d.style.display = 'block'; el('toggleDefault').innerText = '折叠默认名单'; }
    else { d.style.display = 'none'; el('toggleDefault').innerText = '展开默认名单'; }
  });
  el('addBtn').addEventListener('click', ()=>{
    const name = el('newName').value.trim();
    let w = parseFloat(el('newWeight').value);
    if(!name){ alert('请输入名字'); return; }
    if(isNaN(w)) w = 1.0;
    state.list[name] = w;
    el('newName').value = '';
    el('newWeight').value = '1.0';
    saveState();
    renderList(el('search').value.trim());
  });
  el('resetDefault').addEventListener('click', ()=>{
    if(confirm('确定恢复默认名单吗？(会覆盖当前名单)')){
      state.list = {...DEFAULT_LIST};
      state.cooldowns = {};
      saveState();
      renderList();
    }
  });
  el('addSample').addEventListener('click', ()=>{
    const sampleName = '示例_' + Math.floor(Math.random()*1000);
    state.list[sampleName] = 1.0;
    saveState();
    renderList();
  });
  el('search').addEventListener('input', e=> renderList(e.target.value.trim()));
  el('multiplier').addEventListener('change', e=>{
    let v = parseFloat(e.target.value);
    if(isNaN(v) || v < 0) v = 0;
    if(v > 1) v = 1;
    state.multiplier = v;
    el('multiplierLabel').innerText = v;
    saveState();
  });
  el('animationSelect').addEventListener('change', e=>{
    state.animation = e.target.value;
    saveState();
  });
  el('cooldownSeconds').addEventListener('change', e=>{
    let v = parseInt(e.target.value)||0;
    if(v<0) v=0;
    state.cooldownSeconds = v;
    saveState();
  });
  el('importBtn').addEventListener('click', importFromTextarea);
  el('exportBtn').addEventListener('click', exportToTextarea);
  el('downloadBtn').addEventListener('click', downloadJsonFile);
  el('clearHistory').addEventListener('click', ()=> { state.history = []; saveState(); renderHistory(); });
  el('modal').addEventListener('click', (e)=> { if(e.target === el('modal')) closeModal(); });
  el('closeModal').addEventListener('click', closeModal);
  el('animationModal').addEventListener('click', (e)=> { if(e.target === el('animationModal')) closeAnimationModal(); });
  el('cancelAnimation').addEventListener('click', closeAnimationModal);
  el('fileInput').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const obj = JSON.parse(ev.target.result);
        if(typeof obj !== 'object') { alert('格式错误'); return; }
        state.list = {};
        Object.entries(obj).forEach(([k,v])=>{
          const num = Number(v);
          state.list[k] = isNaN(num) ? 0 : num;
        });
        saveState();
        renderList();
        alert('导入成功');
      }catch(err){
        alert('JSON 解析失败');
      }
    };
    reader.readAsText(f);
  });

  el('toggleHistoryStyle').addEventListener('click', ()=>{
    state.historyCompact = !state.historyCompact;
    saveState();
    renderHistory();
  });
}

// initialize
init();
</script>
</body>
</html>
