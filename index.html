<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>权重随机抽人</title>
<style>
 .pointer{
  width:0;
  height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-bottom:22px solid #ef4444;
  position:absolute;
  top:8px;
  left:50%;
  transform:translateX(-50%);
  z-index:10;
}
  :root{
    --accent:#2563eb;
    --muted:#6b7280;
    --bg:#ffffff;
    --card:#f8fafc;
    --radius:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, "Helvetica Neue", Arial, sans-serif;color:#111827;}
  .container{max-width:1100px;margin:28px auto;padding:20px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;align-items:center;}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid #e6edf8;color:var(--accent);font-weight:600}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(12,20,30,0.04);}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:18px;}
  /* left panel */
  .left{display:flex;flex-direction:column;gap:12px}
  .list-header{display:flex;justify-content:space-between;align-items:center}
  .fold-toggle{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px}
  .name-list{max-height:340px;overflow:auto;padding:8px;border-radius:10px;background:#fff;border:1px solid #eef2ff}
  .list-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;margin-bottom:6px}
  .list-row:hover{background:#f1f5f9}
  .name{font-weight:600}
  .weight{font-size:13px;color:var(--muted);margin-left:12px}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:6px}
  .icon-btn{padding:6px 10px;border-radius:8px;border:1px solid #e6eefc;background:white;cursor:pointer;min-width:40px;text-align:center;color: #111827}
  input[type="number"], input[type="text"]{padding:6px;border-radius:8px;border:1px solid #e6e6e6}
  .add-row{display:flex;gap:8px;align-items:center;margin-top:6px}
  .advanced-panel{margin-top:8px;padding:12px;border-radius:10px;background:#fff;border:1px solid #eef2ff}
  label{font-size:13px;color:var(--muted)}
  /* right panel */
  .right{display:flex;flex-direction:column;gap:12px}
  .config{display:flex;gap:12px;align-items:center}
  .config > *{flex:1}
  .big-display{height:220px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#f8fbff);display:flex;align-items:center;justify-content:center;flex-direction:column;border:1px dashed #e6eefc}
  .display-name{font-size:28px;font-weight:700}
  .sub{color:var(--muted);font-size:13px}
  .results{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:white;padding:8px 12px;border-radius:999px;border:1px solid #eef2ff;font-weight:600}
  footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:999;}
  .modal{background:white;padding:18px;border-radius:12px;min-width:320px;max-width:90%}
  .modal h3{margin:0 0 8px 0}
  .modal .result-list{display:flex;gap:8px;flex-wrap:wrap}
  /* collapsed default json */
  .json-area{font-family:monospace;background:#0f172a;color:#f8fafc;padding:10px;border-radius:8px;max-height:160px;overflow:auto}
  /* small screens */
  @media (max-width:880px){
    .layout{grid-template-columns:1fr; }
    .left{order:2}
  }

  .primary-large{background:var(--accent);color:#fff;border:0;padding:12px 18px;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px;box-shadow:0 6px 18px rgba(37,99,235,0.12)}
  /* wheel / roulette styles */
  .wheel-wrap{display:flex;justify-content:center;align-items:center;gap:12px;flex-direction:column;position:relative}
  .wheel{width:280px;height:280px;border-radius:50%;position:relative;overflow:hidden;border:6px solid #fff;box-shadow:0 8px 22px rgba(2,6,23,0.06)}
  .wheel .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;font-weight:700}
  .pointer{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid #ef4444;position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:10}
  .wheel-labels{position:absolute;inset:0;pointer-events:none}
  .wheel-label{position:absolute;left:50%;top:4%;transform-origin:0 50%;white-space:nowrap;font-weight:600;font-size:12px}
  /* small adjustments for wheel text */
  @media (max-width:880px){ .wheel{width:220px;height:220px} }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>权重随机抽人器By-MorningStarsX</h1>
      <div class="small">初始权重 1.0 · 抽中后权重 × <span id="multiplierLabel">0.4</span></div>
    </div>
    <div class="controls">
      <button id="advancedBtn" class="ghost">高级设置</button>
    </div>
  </header>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div class="list-header">
          <strong>名单(折叠)</strong>
          <button class="fold-toggle" id="toggleDefault">展开默认名单</button>
        </div>

        <div id="defaultCollapsed" style="display:none;margin-top:10px;">
          <div class="json-area" id="defaultJson"></div>
        </div>

        <div style="height:8px"></div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="search" placeholder="搜索名字" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eefc">
          <button id="addSample" class="icon-btn" title="添加示例">＋</button>
          <button id="resetDefault" class="icon-btn" title="恢复默认">↺</button>
        </div>

        <div class="name-list" id="nameList"></div>

        <div class="add-row">
          <input id="newName" placeholder="新名字" />
          <input id="newWeight" type="number" step="0.1" value="1.0" style="width:86px" />
          <button id="addBtn">添加</button>
        </div>
      </div>

      <div class="advanced-panel card" id="advancedPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>高级设置</strong>
          <button id="closeAdvanced" class="ghost">关闭</button>
        </div>

        <div style="margin-top:10px;display:grid;gap:8px">
          <label>权重更新量(抽中后乘以)</label>
          <input id="multiplier" type="number" step="0.01" min="0" max="1" value="0.4" />

          <label>抽取动画</label>
          <select id="animationSelect">
            <option value="roulette">轮盘式 (Roulette)</option>
            <option value="turntable">转盘式 (Turntable)</option>
          </select>

          <label>导入名单(JSON 格式：{"名字":1.0, ...})</label>
          <textarea id="importJson" placeholder='{"张三":1.0, "李四":1.0}' rows="4" style="padding:8px;border-radius:8px;border:1px solid #e6eefc"></textarea>
          <div style="display:flex;gap:8px">
            <button id="importBtn" class="ghost">导入名单</button>
            <button id="exportBtn" class="ghost">导出名单</button>
            <button id="downloadBtn" class="ghost">下载 JSON 文件</button>
            <input type="file" id="fileInput" accept=".json" style="display:none" />
          </div>

          <label>默认名单(只读，折叠)</label>
          <div class="json-area" id="defaultJson2" style="max-height:100px"></div>
        </div>
      </div>

    </div>

    <div class="right">
      <div class="card config">
        <div>
          <label>抽取数量(1 = 单人)</label>
          <input id="count" type="number" value="1" min="1" style="width:120px" />
        </div>
        <div>
          <label>是否按顺序更新权重</label>
          <select id="updateMode" style="width:160px">
            <option value="sequential">顺序更新(每次抽后立即更新，影响下一次抽)</option>
            <option value="independent">独立抽取(基于初始权重，同次抽取互不影响)</option>
          </select>
        </div>
        <div>
          <label>动画时长(秒)</label>
          <input id="duration" type="number" min="0.5" step="0.5" value="3" style="width:120px"/>
        </div>
      </div>

      <div class="big-display card">
        <div id="animArea" style="text-align:center;width:100%;padding:10px">
          <div class="display-name" id="animName">准备就绪</div>
          <div class="sub">动画会展示抽取过程，结果将以弹窗显示</div>
        </div>
      </div>

      <div style="text-align:center;margin-top:12px">
        <button id="drawBtn" class="primary-large">开始抽取</button>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>最近抽取结果</strong>
          <button id="clearHistory" class="ghost">清除</button>
        </div>
        <div style="margin-top:8px" id="historyList"></div>
      </div>

      <footer>
        <div>当前总人数：<span id="totalCount">0</span></div>
        <div class="small">数据保存在本地</div>
      </footer>
    </div>
  </div>
</div>

<!-- modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3>抽取结果</h3>
    <div class="result-list" id="modalResults"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="closeModal" class="ghost">关闭</button>
    </div>
  </div>
</div>

<script>
/* ======== 默认名单(2027届17班) ======== */
const DEFAULT_LIST = {
"曾佳怡":1.0, "陈凯":1.0, "陈俐肜":1.0, "陈芋雄":1.0, "陈哲宇":1.0, "陈子萓":1.0, "邓蓉清":1.0, "杜韦鹏":1.0, "方毅":1.0, "符丰牧":1.0,
"符智晨":1.0, "黄艳萍":1.0, "黄志威":1.0, "揭弘毅":1.0, "揭子尧":1.0, "赖聪":1.0, "赖婷":1.0, "赖亚宁":1.0, "赖雨欣":1.0, "赖钰玲":1.0,
"李诚铚":1.0, "李华珍":1.0, "李惠东":1.0, "李哲聪":1.0, "廖鸿瑞":1.0, "廖俊":1.0, "刘扬":1.0, "刘艺":1.0, "马哲灏":1.0, "聂娅馨":1.0,
"瞿世浓":1.0, "饶俊彦":1.0, "饶淑玲":1.0, "饶文垒":1.0, "饶咏坤":1.0, "魏如俊":1.0, "魏志雄":1.0, "魏智萱":1.0, "温粤凡":1.0, "吴博宇":1.0,
"吴海艳":1.0, "吴和兴":1.0, "夏浩轩":1.0, "夏禹豪":1.0, "肖志远":1.0, "谢佳童":1.0, "谢近哲":1.0, "谢雨欣":1.0, "幸天睿":1.0, "熊宇勋":1.0,
"徐子豪":1.0, "杨嘉琦":1.0, "叶丹":1.0, "余凡":1.0, "余梦瑶":1.0
};

/* ======== State & helpers ======== */
let state = {
  list: {}, // {name: weight}
  multiplier: 0.4,
  animation: 'spinner',
  duration: 3,
  history: []
};

const el = id => document.getElementById(id);

function loadState(){
  try{
    const raw = localStorage.getItem('weighted_draw_state_v1');
    if(raw) state = Object.assign(state, JSON.parse(raw));
    else state.list = {...DEFAULT_LIST};
  }catch(e){
    console.warn('loadState err',e);
    state.list = {...DEFAULT_LIST};
  }
}
function saveState(){
  localStorage.setItem('weighted_draw_state_v1', JSON.stringify(state));
}

/* ======== UI 渲染 ======== */
function renderList(filter=''){
  const container = el('nameList');
  container.innerHTML = '';
  const entries = Object.entries(state.list).sort((a,b)=> b[1]-a[1]);
  entries.filter(([n])=> n.toLowerCase().includes(filter.toLowerCase())).forEach(([name, w])=>{
    const row = document.createElement('div');
    row.className = 'list-row';
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="name">${name}</div>
        <div class="weight">权重 ${Number(w).toFixed(3)}</div>
      </div>
      <div class="actions">
        <input type="number" step="0.1" value="${w}" style="width:88px;padding:6px;border-radius:8px;border:1px solid #e6eefc" data-name="${name}" class="editWeight"/>
        <button class="icon-btn" data-name="${name}" data-action="del">删除</button>
      </div>
    `;
    container.appendChild(row);
  });
  el('totalCount').innerText = entries.length;
  // attach edit handlers
  document.querySelectorAll('.editWeight').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const n = e.target.dataset.name;
      let v = parseFloat(e.target.value);
      if(isNaN(v) || v < 0) v = 0;
      state.list[n] = v;
      saveState();
      renderList(el('search').value.trim());
    });
  });
  document.querySelectorAll('button[data-action="del"]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const name = e.currentTarget.dataset.name;
      if(confirm('删除 ' + name + ' ?')){
        delete state.list[name];
        saveState();
        renderList(el('search').value.trim());
      }
    });
  });
}

function renderHistory(){
  const box = el('historyList');
  box.innerHTML = '';
  for(let i=state.history.length-1;i>=0;i--){
    const rec = state.history[i];
    const d = new Date(rec.time).toLocaleString();
    const div = document.createElement('div');
    div.className = 'small';
    div.style.marginBottom='6px';
    div.innerHTML = `<strong>${d}</strong> — ${rec.results.map(r=>`<span class="chip">${r}</span>`).join(' ')}`;
    box.appendChild(div);
  }
}

/* ======== Weighted random pick helpers ======== */
function weightedPickOnce(listObj){
  // listObj: {name: weight}
  const names = Object.keys(listObj);
  const weights = names.map(n=> Number(listObj[n]) );
  const total = weights.reduce((a,b)=>a+b,0);
  if(total <= 0) return null;
  const rnd = Math.random() * total;
  let s = 0;
  for(let i=0;i<names.length;i++){
    s += weights[i];
    if(rnd <= s) return names[i];
  }
  return names[names.length-1];
}

function pickMultiple(count, mode='sequential'){
  // mode: 'sequential' or 'independent'
  const tempList = {...state.list};
  const results = [];
  if(mode === 'independent'){
    // pick k independent samples from original weights (no sequential updates)
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(tempList);
      if(!pick) break;
      results.push(pick);
      // for independent, still optionally reduce weight AFTER all picks? We'll not modify tempList here
    }
    // After independent picks, apply weight reductions to those picked (each may be multiple)
    results.forEach(name=>{
      if(name in state.list){
        state.list[name] = Number(state.list[name]) * Number(state.multiplier);
      }
    });
    return results;
  }else{
    // sequential: after each pick update weight (so next pick affected)
    for(let i=0;i<count;i++){
      const pick = weightedPickOnce(tempList);
      if(!pick) break;
      results.push(pick);
      // update both tempList and real list
      tempList[pick] = Number(tempList[pick]) * Number(state.multiplier);
      if(pick in state.list) state.list[pick] = Number(state.list[pick]) * Number(state.multiplier);
    }
    return results;
  }
}

/* ======== Animation implementations ======== */
// We'll simulate the pick first (without applying updates), animate towards results,
// then apply weight updates and save state. This avoids race conditions and provides
// deterministic animation targets.

function pickSimulated(count, mode){
  // returns array of names selected without mutating state
  const original = {...state.list};
  const names = Object.keys(original);
  if(names.length === 0) return [];
  function weightedOnce(listObj){
    const nms = Object.keys(listObj);
    const w = nms.map(k=> Number(listObj[k]));
    const total = w.reduce((a,b)=>a+b,0);
    if(total <= 0) return null;
    let rnd = Math.random()*total;
    let s=0;
    for(let i=0;i<nms.length;i++){
      s+=w[i];
      if(rnd<=s) return nms[i];
    }
    return nms[nms.length-1];
  }
  const results = [];
  if(mode === 'independent'){
    for(let i=0;i<count;i++){
      const pick = weightedOnce(original);
      if(!pick) break;
      results.push(pick);
    }
    return results;
  }else{
    // sequential: update temp list after each pick
    const temp = {...original};
    for(let i=0;i<count;i++){
      const pick = weightedOnce(temp);
      if(!pick) break;
      results.push(pick);
      temp[pick] = Number(temp[pick]) * Number(state.multiplier);
    }
    return results;
  }
}

// Apply updates to real state after animation
function applyPickedResults(results){
  if(!results || results.length===0) return;
  if(el('updateMode').value === 'independent'){
    results.forEach(name=>{
      if(name in state.list) state.list[name] = Number(state.list[name]) * Number(state.multiplier);
    });
  }else{
    // sequential: apply multiply in order
    results.forEach(name=>{
      if(name in state.list) state.list[name] = Number(state.list[name]) * Number(state.multiplier);
    });
  }
  saveState();
}

function animateAndPick(count){
  const anim = state.animation || el('animationSelect').value;
  const duration = Number(state.duration) || 3;
  if(anim === 'roulette') return rouletteAnimation(duration, count);
  if(anim === 'turntable') return turntableAnimation(duration, count);
  // fallback: simple spinner
  return spinnerAnimation(duration, count);
}

/* legacy spinner (kept as fallback) */
function spinnerAnimation(duration, count){
  const names = Object.keys(state.list);
  if(names.length === 0){
    alert('名单为空');
    return [];
  }
  const display = el('animName');
  let lastIndex = 0;
  const totalMs = duration * 1000;
  return new Promise(resolve=>{
    const t0 = performance.now();
    function step(){
      const now = performance.now();
      const elapsed = now - t0;
      const progress = Math.min(1, elapsed / totalMs);
      const speedFactor = 1 - Math.pow(progress, 2);
      const tick = 30 + Math.round(170 * speedFactor);
      lastIndex = (lastIndex + 1) % names.length;
      display.innerText = names[lastIndex];
      if(elapsed < totalMs){
        setTimeout(step, tick);
      }else{
        // compute simulated results and then apply
        const results = pickSimulated(count, el('updateMode').value);
        applyPickedResults(results);
        resolve(results);
      }
    }
    step();
  });
}
/* ======== Roulette (轮盘式) ========
/* ======== Fixed Roulette Animation ======== */
function rouletteAnimation(duration, count){
  const animArea = el('animArea');
  const names = Object.keys(state.list);
  if(names.length === 0){ alert('名单为空'); return []; }
  const weights = names.map(n=> Number(state.list[n]));
  const total = weights.reduce((a,b)=>a+b,0) || names.length;
  const angles = weights.map(w=> (w/total)*360 );
  const results = pickSimulated(count, el('updateMode').value);
  const targetName = results[0] || names[0];

  // render wheel HTML
  animArea.innerHTML = `
    <div class="wheel-wrap">
      <div class="pointer" aria-hidden="true"></div>
      <div class="wheel" id="wheel" role="img" aria-label="轮盘"></div>
      <div class="center" style="margin-top:8px;font-weight:700" id="wheelCenter">抽取中...</div>
    </div>
  `;
  const wheel = el('wheel');

  // build gradient stops
  const colors = ['#f97316','#f43f5e','#ef4444','#f59e0b','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#64748b'];
  let stops = [], cur = 0;
  for(let i=0;i<angles.length;i++){
    stops.push(`${colors[i % colors.length]} ${cur}deg ${cur+angles[i]}deg`);
    cur += angles[i];
  }
  wheel.style.background = `conic-gradient(${stops.join(',')})`;

  // labels container & labels placement
  const labelsContainer = document.createElement('div');
  labelsContainer.className = 'wheel-labels';
  labelsContainer.style.position = 'absolute';
  labelsContainer.style.inset = '0';
  labelsContainer.style.pointerEvents = 'none';
  wheel.appendChild(labelsContainer);

  const radius = Math.max( (wheel.clientWidth||280)/2 - 48, 80 );
  let curAngle = 0;
  for(let i=0;i<names.length;i++){
    const a = angles[i];
    const angle = curAngle + a/2;
    const label = document.createElement('div');
    label.className = 'wheel-label';
    label.style.position = 'absolute';
    label.style.left = '50%';
    label.style.top = '50%';
    // rotate to angle, translate outward, then counter-rotate so text is readable
    label.style.transform = `rotate(${angle}deg) translate(${radius}px) rotate(${-angle}deg)`;
    label.style.transformOrigin = '0 0';
    label.style.fontSize = '12px';
    label.style.whiteSpace = 'nowrap';
    label.innerText = names[i];
    labelsContainer.appendChild(label);
    curAngle += a;
  }

  // compute target sector center angle
  let acc = 0, targetCenter = 0;
  for(let i=0;i<names.length;i++){
    const a = angles[i];
    if(names[i] === targetName){
      targetCenter = acc + a/2;
      break;
    }
    acc += a;
  }

  // spin and land on targetCenter (negative rotation so pointer at top matches)
  const spins = 6;
  const finalRotation = -(spins*360 + targetCenter);
  wheel.style.transformOrigin = '50% 50%';
  wheel.style.transition = `transform ${duration}s cubic-bezier(.2,.9,.2,1)`;
  // trigger layout
  void wheel.offsetWidth;
  wheel.style.transform = `rotate(${finalRotation}deg)`;

  return new Promise(resolve=>{
    setTimeout(()=>{
      // apply results to state after animation
      applyPickedResults(results);
      // briefly show result in anim area
      setTimeout(()=>{
        animArea.innerHTML = `<div class="display-name" id="animName">${results.map((r,i)=> (i+1)+'. '+r).join('  ')}</div><div class="sub">抽取完成</div>`;
      },300);
      resolve(results);
    }, duration*1000 + 220);
  });
}

/* ======== Turntable (转盘式) ========
/* ======== Fixed Turntable Animation ======== */
function turntableAnimation(duration, count){
  const animArea = el('animArea');
  const names = Object.keys(state.list);
  if(names.length === 0){ alert('名单为空'); return []; }
  const results = pickSimulated(count, el('updateMode').value);
  const targetName = results[0] || names[0];

  animArea.innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
      <div style="position:relative;width:100%;max-width:520px;overflow:hidden;padding:10px">
        <div id="track" style="display:flex;gap:12px;transform:translateX(0);will-change:transform"></div>
        <div style="position:absolute;left:50%;top:12px;transform:translateX(-50%);pointer-events:none">
          <div class="pointer" aria-hidden="true" style="border-bottom-color:#ef4444"></div>
        </div>
      </div>
      <div id="turnCenter" style="font-weight:700">${targetName}</div>
    </div>
  `;
  const track = el('track');

  // populate track with chips (one sequence), then repeat it to allow long scroll
  names.forEach(n=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.style.minWidth = '120px';
    chip.style.textAlign = 'center';
    chip.innerText = n;
    track.appendChild(chip);
  });
  // duplicate sequence several times
  const original = Array.from(track.children);
  for(let r=0;r<6;r++){
    original.forEach(c=> track.appendChild(c.cloneNode(true)));
  }

  // find first occurrence of targetName in the track
  let targetIndex = -1;
  for(let i=0;i<track.children.length;i++){
    if(track.children[i].innerText === targetName){ targetIndex = i; break; }
  }
  if(targetIndex < 0) targetIndex = 0;

  return new Promise(resolve=>{
    setTimeout(()=>{
      const parentRect = track.parentElement.getBoundingClientRect();
      const child = track.children[targetIndex];
      const wrapWidth = track.parentElement.clientWidth;
      const offset = child.offsetLeft + child.offsetWidth/2 - wrapWidth/2;
      track.style.transition = `transform ${duration}s cubic-bezier(.2,.9,.2,1)`;
      track.style.transform = `translateX(${-offset}px)`;

      // polling to update center label during animation
      const poll = setInterval(()=>{
        const pr = track.parentElement.getBoundingClientRect();
        let best = {idx:-1, dist:Infinity, name:''};
        for(let i=0;i<track.children.length;i++){
          const c = track.children[i];
          const r = c.getBoundingClientRect();
          const cx = r.left + r.width/2;
          const d = Math.abs(cx - (pr.left + pr.width/2));
          if(d < best.dist){ best = {idx:i, dist:d, name: c.innerText}; }
        }
        if(best.idx >= 0){
          el('turnCenter').innerText = best.name;
        }
      }, 60);

      // after animation, stop polling, apply results
      setTimeout(()=>{
        clearInterval(poll);
        applyPickedResults(results);
        el('turnCenter').innerText = results.map((r,i)=> (i+1)+'. '+r).join('  ');
        resolve(results);
      }, duration*1000 + 120);
    }, 40);
  });
}
/* ======== Drawing flow ======== */
async function doDraw(){
  // sanity
  const count = Math.max(1, Math.floor(Number(el('count').value) || 1));
  if(Object.keys(state.list).length === 0){
    alert('名单为空，无法抽取');
    return;
  }
  // disable button
  el('drawBtn').disabled = true;
  el('drawBtn').innerText = '抽取中...';
  // run animation + picks
  try{
    const results = await animateAndPick(count);
    // save history and state
    state.history = state.history || [];
    state.history.push({time:Date.now(), results});
    saveState();
    renderHistory();
    // show modal with results
    showModal(results);
    // refresh list display
    renderList(el('search').value.trim());
  }catch(err){
    console.error(err);
    alert('抽取发生错误');
  }finally{
    el('drawBtn').disabled = false;
    el('drawBtn').innerText = '开始抽取';
  }
}

/* ======== Modal ======== */
function showModal(results){
  const md = el('modal');
  const resultsDiv = el('modalResults');
  resultsDiv.innerHTML = '';
  results.forEach((r,i)=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.style.fontSize = '16px';
    chip.innerText = `${i+1}. ${r}`;
    resultsDiv.appendChild(chip);
  });
  md.style.display = 'flex';
}
function closeModal(){
  el('modal').style.display = 'none';
}

/* ======== Import/Export ======== */
function importFromTextarea(){
  const txt = el('importJson').value.trim();
  if(!txt) { alert('请输入 JSON'); return; }
  try{
    const obj = JSON.parse(txt);
    if(typeof obj !== 'object'){ alert('格式错误'); return; }
    state.list = {};
    Object.entries(obj).forEach(([k,v])=>{
      const num = Number(v);
      state.list[k] = isNaN(num) ? 0 : num;
    });
    saveState();
    renderList();
    alert('导入成功');
  }catch(e){
    alert('JSON 解析失败');
  }
}

function exportToTextarea(){
  el('importJson').value = JSON.stringify(state.list, null, 2);
}

function downloadJsonFile(){
  const data = JSON.stringify(state.list, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'name_list.json';
  a.click();
  URL.revokeObjectURL(url);
}

/* ======== Init & event bindings ======== */
function init(){
  loadState();
  // fill default json display
  el('defaultJson').innerText = JSON.stringify(DEFAULT_LIST, null, 2);
  el('defaultJson2').innerText = JSON.stringify(DEFAULT_LIST, null, 2);
  // initial UI values
  el('multiplier').value = state.multiplier;
  el('animationSelect').value = (['roulette','turntable'].includes(state.animation) ? state.animation : 'roulette'); state.animation = el('animationSelect').value;
  el('duration').value = state.duration;
  el('multiplierLabel').innerText = state.multiplier;
  renderList();
  renderHistory();

  // events
  el('drawBtn').addEventListener('click', doDraw);
  el('advancedBtn').addEventListener('click', ()=> el('advancedPanel').style.display = 'block');
  el('closeAdvanced').addEventListener('click', ()=> el('advancedPanel').style.display = 'none');
  el('toggleDefault').addEventListener('click', ()=>{
    const d = el('defaultCollapsed');
    if(d.style.display === 'none'){ d.style.display = 'block'; el('toggleDefault').innerText = '折叠默认名单'; }
    else { d.style.display = 'none'; el('toggleDefault').innerText = '展开默认名单'; }
  });
  el('addBtn').addEventListener('click', ()=>{
    const name = el('newName').value.trim();
    let w = parseFloat(el('newWeight').value);
    if(!name){ alert('请输入名字'); return; }
    if(isNaN(w)) w = 1.0;
    state.list[name] = w;
    el('newName').value = '';
    el('newWeight').value = '1.0';
    saveState();
    renderList(el('search').value.trim());
  });
  el('resetDefault').addEventListener('click', ()=>{
    if(confirm('确定恢复默认名单吗？(会覆盖当前名单)')){
      state.list = {...DEFAULT_LIST};
      saveState();
      renderList();
    }
  });
  el('addSample').addEventListener('click', ()=>{
    const sampleName = '示例_' + Math.floor(Math.random()*1000);
    state.list[sampleName] = 1.0;
    saveState();
    renderList();
  });
  el('search').addEventListener('input', e=> renderList(e.target.value.trim()));
  el('multiplier').addEventListener('change', e=>{
    let v = parseFloat(e.target.value);
    if(isNaN(v) || v < 0) v = 0;
    if(v > 1) v = 1;
    state.multiplier = v;
    el('multiplierLabel').innerText = v;
    saveState();
  });
  el('animationSelect').addEventListener('change', e=>{
    state.animation = e.target.value;
    saveState();
  });
  el('duration').addEventListener('change', e=>{
    const v = Number(e.target.value) || 3;
    state.duration = v;
    saveState();
  });
  el('importBtn').addEventListener('click', importFromTextarea);
  el('exportBtn').addEventListener('click', exportToTextarea);
  el('downloadBtn').addEventListener('click', downloadJsonFile);
  el('clearHistory').addEventListener('click', ()=> { state.history = []; saveState(); renderHistory(); });
  el('modal').addEventListener('click', (e)=> { if(e.target === el('modal')) closeModal(); });
  el('closeModal').addEventListener('click', closeModal);
  // file input for JSON
  el('fileInput').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const obj = JSON.parse(ev.target.result);
        if(typeof obj !== 'object') { alert('格式错误'); return; }
        state.list = {};
        Object.entries(obj).forEach(([k,v])=>{
          const num = Number(v);
          state.list[k] = isNaN(num) ? 0 : num;
        });
        saveState();
        renderList();
        alert('导入成功');
      }catch(err){
        alert('JSON 解析失败');
      }
    };
    reader.readAsText(f);
  });

  // support clicking export to open file picker for import
  // (not necessary but helpful)
  // show multiplier label
  el('multiplierLabel').innerText = state.multiplier;

  // ensure UI animArea default
  el('animArea').innerHTML = `<div class="display-name" id="animName">准备就绪</div><div class="sub">动画会展示抽取过程，结果将以弹窗显示</div>`;
}

init();
</script>
</body>
</html>
